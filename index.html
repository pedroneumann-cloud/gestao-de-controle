
<!DOCTYPE html>
<!-- saved from url=(0130)file:///C:/Users/Windows%20%2011/AppData/Local/Temp/746cb81b-3bac-4883-9219-3afcdc8129af_sistema_gestao_compras.zip.9af/index.html -->
<html lang="pt-BR"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sistema de Compra</title>
<style>
:root{
  --bg:#050505;
  --panel:#0b0d10;
  --muted:#9aa1a6;
  --accent:#00b894;
  --glass: rgba(255,255,255,0.03);
  --glass-strong: rgba(255,255,255,0.06);
  --card:#070809;
  --text:#e6eef1;
  --input-bg:#0a0b0c;
  --select-bg:#0c0d0e;
  --danger:#ff7675;
  --warning:#fdcb6e;
  --info:#74b9ff;
  --success:#00b894;
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg) 0%, #0a0a0b 100%);color:var(--text);-webkit-font-smoothing:antialiased}
a{color:inherit}
.container{max-width:1100px;margin:18px auto;padding:16px}
.center-screen{min-height:80vh;display:flex;align-items:center;justify-content:center}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#006266);display:flex;align-items:center;justify-content:center;font-weight:800;color:#021}
.title{font-size:20px;font-weight:700}
.small-muted{font-size:12px;color:var(--muted)}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;transition:transform .12s,background .12s}
.btn:hover{transform:translateY(-2px);background:rgba(255,255,255,0.02)}
.btn.primary{background:linear-gradient(90deg,var(--accent),#00d68f);color:#021;border:none}
.btn.secondary{background:linear-gradient(90deg,var(--info),#0984e3);color:#021;border:none}
.btn.warning{background:linear-gradient(90deg,var(--warning),#e17055);color:#021;border:none}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.005));border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03)}
.grid{display:grid;grid-template-columns:360px 1fr;gap:16px}
.input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:var(--input-bg);color:var(--text);font-size:14px}
.select-dark{background:var(--select-bg);color:var(--text)}
.form-row{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;align-items:center}
.products-list{margin-top:10px;display:flex;flex-direction:column;gap:10px;max-height:420px;overflow:auto;padding-right:6px}
.product{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:10px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02);cursor:pointer}
.pname{font-weight:700}
.meta{font-size:13px;color:var(--muted)}
.product-actions{display:flex;gap:8px;align-items:center}
.icon-btn{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;cursor:pointer;color:var(--muted);font-weight:700}
.statlist{display:flex;gap:8px;align-items:stretch;margin-bottom:10px}
.stat{background:rgba(255,255,255,0.01);padding:10px;border-radius:10px;text-align:center;flex:1;border:1px solid rgba(255,255,255,0.02)}
.stat .num{font-weight:800;font-size:18px}
.footer{margin-top:16px;display:flex;gap:10px;align-items:center;justify-content:flex-end;color:var(--muted)}
.limit-badge{background:rgba(255,255,255,0.02);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.02);font-size:13px}
.empty{opacity:0.7;color:var(--muted);padding:14px;text-align:center}

/* LOGIN */
.login-wrap{width:100%;max-width:440px;padding:22px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.04);backdrop-filter:blur(8px)}
.login-title{font-size:22px;font-weight:800;margin-bottom:4px}
.subtle{color:var(--muted);font-size:13px;margin-bottom:10px}

/* MODAL / DETAILS (ensure black bg) */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:60}
.modal{width:calc(100% - 40px);max-width:720px;background:#000;border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 22px 60px rgba(0,0,0,0.8);color:var(--text)}
.tx-table{width:100%;border-collapse:collapse;margin-top:8px}
.tx-table th{color:var(--muted);text-align:left;padding:8px;font-size:13px}
.tx-table td{padding:8px;border-top:1px dashed rgba(255,255,255,0.03);font-size:14px}

/* topbar */
.topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
.user-pill{display:flex;gap:10px;align-items:center;background:rgba(255,255,255,0.02);padding:8px;border-radius:999px;border:1px solid rgba(255,255,255,0.03)}
.role-admin{color:var(--accent);font-weight:800}
.role-view{color:var(--muted);font-weight:700}
.role-client{color:var(--info);font-weight:700}

/* small touches */
.small{font-size:13px;color:var(--muted)}
.sep{height:1px;background:rgba(255,255,255,0.02);margin:12px 0;border-radius:2px}

/* status badges */
.status-badge{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
.status-pending{background:rgba(253,203,110,0.1);color:var(--warning)}
.status-preparing{background:rgba(116,185,255,0.1);color:var(--info)}
.status-shipping{background:rgba(0,184,148,0.1);color:var(--accent)}
.status-delivered{background:rgba(0,184,148,0.2);color:var(--accent);border:1px solid rgba(0,184,148,0.3)}
.status-cancelled{background:rgba(255,118,117,0.1);color:var(--danger)}
.status-paid{background:rgba(0,184,148,0.3);color:var(--success);border:1px solid rgba(0,184,148,0.5)}

/* responsive */
@media(max-width:900px){
  .grid{grid-template-columns:1fr}
  .logo{width:46px;height:46px}
  .product{padding:10px}
  .center-screen{padding:18px}
  .container{padding:12px}
  .header{flex-direction:column;align-items:stretch;gap:8px}
  .topbar{flex-direction:column;align-items:stretch;gap:8px}
  .user-pill{justify-content:center;margin-top:8px}
  .form-row{flex-direction:column;align-items:stretch}
  .form-row > *{width:100% !important}
  .statlist{flex-direction:column}
  .product{flex-direction:column;align-items:stretch;gap:8px}
  .product-actions{justify-content:center}
  .modal{width:95%;margin:10px;padding:14px}
}

/* fix selects in chrome mobile */
select::-ms-expand { display: none; }

/* tabs */
.tabs{display:flex;gap:4px;background:rgba(255,255,255,0.01);padding:4px;border-radius:10px;margin-bottom:12px}
.tab{flex:1;text-align:center;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700;transition:background .12s}
.tab.active{background:rgba(255,255,255,0.05)}

/* purchase history */
.history-item{padding:10px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02);margin-bottom:8px}
.history-date{font-size:12px;color:var(--muted)}
.history-products{margin-top:6px}
.history-product{display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px}

/* admin access */
.admin-access{display:none;margin-top:12px}

/* phone input */
.phone-input{font-family:monospace;letter-spacing:1px}

/* mobile optimizations */
@media(max-width:480px){
  .login-wrap{padding:16px;margin:10px}
  .btn{padding:12px 16px;font-size:14px}
  .input,select,textarea{padding:12px;font-size:16px}
  .products-list{max-height:300px}
}

/* ===== FIX FINAL: Z-index e hierarquia de exibição ===== */
#screen-root { 
  z-index: 5; 
}
#app { 
  z-index: 10; 
  position: relative; 
}
#loginCard{
  display:block !important;
  width:100%;
  max-width:440px;
  margin:auto;
  opacity:0;
  transform:translateY(-10px);
  transition:0.25s ease-out;
}

</style>
<script src="./Sistema de Compra_files/js" async=""></script></head>
<body>

<div class="center-screen" id="screen-root" style="display: flex;">
  <!-- LOGIN -->
  <div class="login-wrap card" id="loginCard" style="transform: translateY(0px); opacity: 1; transition: 0.45s cubic-bezier(0.2, 0.9, 0.25, 1); display: flex;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div class="brand"><div class="logo">SC</div><div><div class="login-title">Sistema de Compra</div><div class="subtle">Escolha seu tipo de acesso</div></div></div>
      <div class="small-muted">Profissional • Dark</div>
    </div>

    <div class="tabs" id="loginTabs">
      <div class="tab active" data-tab="client">Cliente</div>
      <div class="tab" data-tab="admin">Administrador</div>
    </div>

    <!-- Client Login -->
    <div id="clientLogin" style="display:block">
      <div style="margin-top:8px">
        <label class="small">E-mail</label>
        <input id="clientEmail" class="input" placeholder="seu-email@gmail.com" autocomplete="email">
      </div>
      <div style="margin-top:8px">
        <label class="small">Senha</label>
        <input id="clientPassword" type="password" class="input" placeholder="Sua senha" autocomplete="current-password">
      </div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="clientLoginBtn" class="btn primary">Entrar como Cliente</button>
        <button id="clientRegisterBtn" class="btn">Registrar Cliente</button>
      </div>
      <div class="small" style="margin-top:10px;color:var(--muted)">É necessário fazer login para realizar compras.</div>
    </div>

    <!-- Admin Login -->
    <div id="adminLogin" style="display:none">
      <div id="adminAccessForm">
        <div style="margin-top:8px">
          <label class="small">Senha de Acesso ADM</label>
          <input id="adminAccessPassword" type="password" class="input" placeholder="Digite a senha de acesso ADM">
        </div>
        <div style="margin-top:10px">
          <button id="adminAccessBtn" class="btn primary">Acessar Painel ADM</button>
        </div>
      </div>

      <div id="adminLoginForm" class="admin-access">
        <div style="margin-top:8px">
          <label class="small">E-mail</label>
          <input id="loginEmail" class="input" placeholder="seu-email@gmail.com" autocomplete="email">
        </div>
        <div style="margin-top:8px">
          <label class="small">Senha</label>
          <input id="loginPassword" type="password" class="input" placeholder="Sua senha" autocomplete="current-password">
        </div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="loginBtn" class="btn primary">Entrar</button>
          <button id="registerBtn" class="btn">Registrar ADM</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- APP (hidden until login) -->
<div class="container" id="app" style="display:none;opacity:0;transition:opacity .35s">
  <div class="header card topbar">
    <div style="display:flex;align-items:center;gap:12px">
      <div class="brand"><div class="logo">SC</div><div><div class="title">Sistema de Compra</div><div class="small-muted" id="userSubtitle">Gestão personalizada por e-mail</div></div></div>
    </div>
    <div style="display:flex;align-items:center;gap:10px">
      <div class="user-pill" id="userInfo"><div class="small-muted">Logado como:</div><div id="userEmail" style="font-weight:800"></div><div id="userRole" class="role-view"></div></div>
      <div style="display:flex;gap:8px">
        <button id="logoutBtn" class="btn">Sair</button>
      </div>
    </div>
  </div>

  <div id="notice" style="display:none;margin-bottom:10px" class="card small-muted"></div>

  <!-- Admin Panel -->
  <div id="adminPanel" style="display:none">
    <div class="grid">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div><strong>Cadastro / Estoque</strong><div class="small-muted">Máx 10 itens por conta</div></div>
          <div class="limit-badge" id="countBadge">0 / 10</div>
        </div>

        <div class="label">Nome do produto</div>
        <input id="pName" class="input" placeholder="Ex: Produto X">

        <div class="form-row">
          <div style="flex:1">
            <div class="label">Preço de custo (R$)</div>
            <input id="pCost" class="input" type="number" min="0" step="0.01">
          </div>
          <div style="width:140px">
            <div class="label">Preço de venda (R$)</div>
            <input id="pPrice" class="input" type="number" min="0" step="0.01">
          </div>
        </div>

        <div class="form-row" style="margin-top:8px">
          <div style="flex:1">
            <div class="label">Quantidade</div>
            <input id="pQty" class="input" type="number" min="0" step="1">
          </div>
          <div style="width:140px">
            <div class="label">Categoria</div>
            <input id="pCat" class="input">
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="addProduct" class="btn primary">Adicionar / Atualizar</button>
          <button id="resetForm" class="btn">Limpar</button>
        </div>

        <div class="sep"></div>

        <div class="label">Operação rápida (entrada / saída)</div>
        <div class="form-row">
          <select id="opProduct" class="input select-dark"><option value="">Escolha um produto</option></select>
          <input id="opQty" class="input" type="number" placeholder="Qtd">
          <select id="opType" class="input select-dark"><option value="in">Entrada</option><option value="out">Saída</option></select>
          <button id="applyOp" class="btn">Aplicar</button>
        </div>

        <div class="small-muted" style="margin-top:10px">As ações de modificar/excluir são restritas a administradores. Visualizadores apenas leem dados.</div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <strong>Painel</strong>
          <div class="small-muted">Visualização por conta</div>
        </div>

        <div class="statlist">
          <div class="stat"><div class="small-muted">Total em estoque</div><div class="num" id="totalStock">R$ 0,00</div></div>
          <div class="stat"><div class="small-muted">Total vendido</div><div class="num" id="totalSold">R$ 0,00</div></div>
          <div class="stat"><div class="small-muted">Lucro total</div><div class="num" id="totalProfit">R$ 0,00</div></div>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Produtos</strong>
          <div class="small-muted">Toque para ver detalhes</div>
        </div>

        <div class="products-list" id="productsList">
          <div class="empty">Nenhum produto cadastrado.</div>
        </div>

        <div style="margin-top:12px">
          <strong>Transações</strong>
          <table class="tx-table" id="txTable"><thead><tr><th>Data</th><th>Produto</th><th>Tipo</th><th>Qtd</th><th>Detalhes</th></tr></thead><tbody><tr><td colspan="5" class="empty">Sem transações.</td></tr></tbody></table>
        </div>

        <div class="footer">Dados salvos localmente por e-mail • Máx 10 itens</div>
      </div>
    </div>

    <!-- Orders Management -->
    <div class="card" style="margin-top:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <strong>Gerenciamento de Pedidos</strong>
        <div class="small-muted">Controle de pedidos dos clientes</div>
      </div>

      <div class="products-list" id="ordersList">
        <div class="empty">Nenhum pedido realizado.</div>
      </div>
    </div>
  </div>

  <!-- Client Panel -->
  <div id="clientPanel" style="display:none">
    <!-- Shopping Area -->
    <div id="shoppingArea">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <strong>Loja Virtual</strong>
          <div class="small-muted">Escolha seus produtos</div>
        </div>

        <div class="products-list" id="storeProductsList">
          <div class="empty">Nenhum produto disponível.</div>
        </div>

        <div class="sep"></div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <strong>Carrinho de Compras</strong>
          <div class="small-muted" id="cartCount">0 itens</div>
        </div>

        <div id="cartItems" class="products-list">
          <div class="empty">Carrinho vazio</div>
        </div>

        <div style="margin-top:12px">
          <button id="checkoutBtn" class="btn primary" style="width:100%">Finalizar Pedido</button>
        </div>
      </div>
    </div>

    <!-- Order Tracking -->
    <div id="orderTracking" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <strong>Meus Pedidos</strong>
          <div class="small-muted">Acompanhe seus pedidos</div>
        </div>

        <div class="products-list" id="clientOrdersList">
          <div class="empty">Nenhum pedido realizado.</div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="backToShopBtn" class="btn secondary">Voltar para a Loja</button>
          <button id="viewHistoryBtn" class="btn">Ver Histórico Completo</button>
        </div>
      </div>
    </div>

    <!-- Purchase History -->
    <div id="purchaseHistory" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <strong>Histórico de Compras</strong>
          <div class="small-muted">Todos os seus pedidos realizados</div>
        </div>

        <div id="historyList">
          <div class="empty">Nenhuma compra realizada.</div>
        </div>

        <div style="margin-top:12px">
          <button id="backToTrackingBtn" class="btn secondary">Voltar para Pedidos</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="modalRoot" style="display:none"></div>
<script type="module">
// =========================================================================
// BLOCO 1: FIREBASE - IMPORTAÇÕES E CONFIGURAÇÃO
// =========================================================================

// Importações
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
import { initializeFirestore, getFirestore, collection, addDoc, doc, setDoc, getDoc, getDocs, query, where, orderBy, updateDoc, serverTimestamp, persistentLocalCache, persistentMultipleTabManager, onSnapshot } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
 
// Firebase config (Suas credenciais)
const firebaseConfig = {
    // ATENÇÃO: COLOQUE AQUI AS CREDENCIAIS CORRETAS DO SEU PROJETO FIREBASE!
    apiKey: "AIzaSyATJ1ZGggZti53nko9LMemQFo7wHwaWXVE", 
    authDomain: "banco-de-dados-4dd4d.firebaseapp.com",
    projectId: "banco-de-dados-4dd4d",
    storageBucket: "banco-de-dados-4dd4d.firebasestorage.app",
    messagingSenderId: "1002214156963",
    appId: "1:1002214156963:web:43aeca6f25a71f42fced16",
    measurementId: "G-5NL2Z4D91B"
};

// Inicialização da Aplicação
let app;
if (getApps().length === 0) {
    app = initializeApp(firebaseConfig);
    console.log("[Firebase] Aplicativo inicializado com sucesso (DEFAULT).");
} else {
    app = getApps()[0]; 
    console.log("[Firebase] Aplicativo já estava inicializado (DEFAULT).");
}

try { getAnalytics(app); } catch(e) { /* ignore if analytics not allowed */ }

// Inicialização do Firestore
let db;
try {
    db = initializeFirestore(app, {
        localCache: persistentLocalCache({ tabManager: persistentMultipleTabManager() })
    });
    console.log('[Firebase] Firestore initialized with persistentLocalCache.');
} catch(e) {
    db = getFirestore(app);
    console.warn('[Firebase] persistentLocalCache not available; using getFirestore fallback.', e);
}

const auth = getAuth(app); 

// =========================================================================
// BLOCO 2: HELPERS, STATE E STUBS
// =========================================================================

// Helpers
const log = (...a) => console.log('[Firebase]', ...a);
const el = id => document.getElementById(id); 
const SHOP_ID = 'mainADM';
const SHOP_DOC_PATH = ['shops', SHOP_ID];
const MAX_ITEMS = 10; 

// State
let state = { 
    email: null, 
    role: 'viewer', 
    data: { products: [], transactions: [] }, 
    adminEmail: null,
    clientData: { orders: [], purchaseHistory: [] },
    cart: [],
    currentView: 'shop'
};

// UTILS
function money(v){ return 'R$ ' + Number(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2}); }
function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
function storageKey(email){ return 'sc_user_' + email.toLowerCase(); }
function clientStorageKey(email){ return 'sc_client_' + email.toLowerCase(); }
function ordersStorageKey(){ return 'sc_orders'; }
function formatPhoneNumber(value) {
    const numbers = value.replace(/\D/g, '');
    const limited = numbers.slice(0, 11);
    if (limited.length <= 10) {
        return limited.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
    } else {
        return limited.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
    }
}

// STUBS (Funções que a lógica de login chama e precisam existir)
function loadAdminProducts() { 
    console.log('[STUB] loadAdminProducts chamado.'); 
}
function loadOrders() { 
    console.log('[STUB] loadOrders chamado.'); 
}
function applyRoleRestrictions() { 
    console.log('[STUB] applyRoleRestrictions chamado.'); 
}
function renderAll() { 
    console.log('[STUB] renderAll chamado.'); 
}
function renderClientViews() { 
    console.log('[STUB] renderClientViews chamado.'); 
}
function showLoginAnimation(){ 
    const card = el('loginCard'); 
    setTimeout(()=>{ card.style.transform='translateY(0)'; card.style.opacity='1'; },80); 
}


// =========================================================================
// BLOCO 3: LÓGICA DE NEGÓCIO E UI
// =========================================================================

// Ensure Shop e Migração (MANTIDAS)
async function ensureShop() {
    try {
        const shopRef = doc(db, ...SHOP_DOC_PATH);
        const snap = await getDoc(shopRef);
        if (!snap.exists()) {
            await setDoc(shopRef, { name: "Lucão Store", createdAt: serverTimestamp() });
            log('Loja criada: Lucão Store');
        } else {
            log('Loja já existe no Firestore.');
        }
    } catch(err) { console.error('[Firebase] ensureShop error', err); }
}

async function migrateLocalToFirestore() {
    // Este código deve ser mantido completo se você o tinha em seu index.html
    try {
        log('Migração localStorage → Firestore finalizada.');
    } catch(err) {
        console.error('[Firebase] migrateLocalToFirestore error', err);
    }
}

// Funções de UI Pós-Autenticação 
function loginAdminAfterAuth(email, role) {
    state.email = email;
    state.role = role;

    el('userEmail').textContent = state.email;
    el('userRole').textContent = role === 'admin' ? ' • ADM' : '';
    el('userRole').className = role === 'admin' ? 'role-admin' : 'role-view';
    el('userSubtitle').textContent = 'Painel de Administração';

    // Esconde login e mostra app corretamente
    el('loginCard').style.display = 'none';
    el('screen-root').style.display = 'none';
    el('app').style.display = 'block';
    el('app').style.opacity = '1';
    el('adminPanel').style.display = 'block';
    el('clientPanel').style.display = 'none';


    document.getElementById('loginCard').style.display='none'; 
    document.getElementById('screen-root').style.display='none';
    const app = el('app'); app.style.display = 'block'; 
    el('adminPanel').style.display = 'block';
    el('clientPanel').style.display = 'none';

    loadAdminProducts(); 
    loadOrders(); 

    setTimeout(()=> app.style.opacity = '1',40);
    applyRoleRestrictions();
    renderAll(); 
}

function loginClientAfterAuth(email, role) {
    state.email = email;
    state.role = role;

    el('userEmail').textContent = state.email;
    el('userRole').textContent = ' • Cliente';
    el('userRole').className = 'role-client';
    el('userSubtitle').textContent = 'Área do Cliente';

    // Esconde login e mostra app corretamente
    el('loginCard').style.display = 'none';
    el('screen-root').style.display = 'none';
    el('app').style.display = 'block';
    el('app').style.opacity = '1';
    el('adminPanel').style.display = 'none';
    el('clientPanel').style.display = 'block';


    document.getElementById('loginCard').style.display='none'; 
    document.getElementById('screen-root').style.display='none';
    const app = el('app'); app.style.display = 'block'; 
    el('adminPanel').style.display = 'none';
    el('clientPanel').style.display = 'block';

    loadAdminProducts(); 
    loadOrders(); 

    setTimeout(()=> app.style.opacity = '1',40);
    renderClientViews(); 
}

// NOVO: Admin registration (CORRIGIDO PARA O ESCOPO)
function registerAdmin(email, password) {
    createUserWithEmailAndPassword(auth, email, password)
      .then((userCredential) => {
        const user = userCredential.user;
        const userDocRef = doc(db, "users", user.uid);
        return setDoc(userDocRef, { role: 'admin', email: email.toLowerCase() });
      })
      .then(() => {
        alert('Conta de administrador registrada com sucesso no Firebase!');
        el('registerBtn').style.display = 'none';
      })
      .catch((error) => {
        console.error("Erro no registro de ADM:", error);
        alert('Erro ao registrar ADM: ' + (error.code || error.message));
      });
}

// NOVO: Client registration (Adicionado para completar a lógica)
function registerClient(email, password) {
    createUserWithEmailAndPassword(auth, email, password)
      .then((userCredential) => {
        const user = userCredential.user;
        const userDocRef = doc(db, "users", user.uid);
        return setDoc(userDocRef, { role: 'client', email: email.toLowerCase() });
      })
      .then(() => {
        alert('Conta de cliente registrada com sucesso!');
      })
      .catch((error) => {
        console.error("Erro no registro de Cliente:", error);
        alert('Erro ao registrar cliente: ' + (error.code || error.message));
      });
}

// Phone input formatter
function setupPhoneInput(inputId) {
    const input = el(inputId);
    if (!input) return;
    input.addEventListener('input', function(e) {
        const cursorPosition = e.target.selectionStart;
        const formatted = formatPhoneNumber(e.target.value);
        e.target.value = formatted;
        const extraChars = formatted.length - e.target.value.length;
        e.target.setSelectionRange(cursorPosition + extraChars, cursorPosition + extraChars);
    });
    input.addEventListener('keydown', function(e) {
        if (!/[\d]|Backspace|Delete|ArrowLeft|ArrowRight|Tab/.test(e.key)) {
            e.preventDefault();
        }
    });
}
setupPhoneInput('clientPhone'); // Exemplo: se você tiver um campo com ID 'clientPhone'

// Login handlers (AGORA CHAMANDO FIREBASE AUTH)
el('loginBtn').onclick = ()=> { 
    const email = el('loginEmail').value.trim(); 
    const password = el('loginPassword').value;
    if(!email || !email.includes('@') || !password) return alert('Preencha e-mail e senha.');
    
    signInWithEmailAndPassword(auth, email, password)
        .catch(error => {
            console.error("Erro no login ADM:", error);
            alert('Erro no Login: ' + error.message);
        });
}

el('registerBtn').onclick = ()=> { 
    const email = el('loginEmail').value.trim(); 
    const password = el('loginPassword').value;
    if(!email || !email.includes('@')) return alert('Digite um e-mail válido.'); 
    if(!password) return alert('Digite uma senha.');
    registerAdmin(email, password); 
}

el('clientLoginBtn').onclick = ()=> { 
    const email = el('clientEmail').value.trim(); 
    const password = el('clientPassword').value;
    if(!email || !email.includes('@') || !password) return alert('Preencha e-mail e senha.');
    
    signInWithEmailAndPassword(auth, email, password)
        .catch(error => {
            console.error("Erro no login Cliente:", error);
            alert('Erro no Login: ' + error.message);
        });
}

el('clientRegisterBtn').onclick = ()=> { 
    const email = el('clientEmail').value.trim(); 
    const password = el('clientPassword').value;
    if(!email || !email.includes('@')) return alert('Digite um e-mail válido.'); 
    if(!password) return alert('Digite uma senha.');
    registerClient(email, password); 
}

el('viewHistoryBtn').onclick = () => {
    state.currentView = 'history';
    renderClientViews();
};

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const tabType = tab.getAttribute('data-tab');
        if (tabType === 'admin') {
            el('adminLogin').style.display = 'block';
            el('clientLogin').style.display = 'none';
        } else {
            el('adminLogin').style.display = 'none';
            el('clientLogin').style.display = 'block';
        }
    });
});

// Admin access password
el('adminAccessBtn').onclick = () => {
    const password = el('adminAccessPassword').value;
    if (password === 'Lucãoadm') {
        el('adminAccessForm').style.display = 'none';
        el('adminLoginForm').style.display = 'block';
        
        // Esta checagem é feita pelo Firebase, mas mantida para a lógica de UI
        // el('registerBtn').style.display = 'none'; 
    } else {
        alert('Senha de acesso ADM incorreta!');
    }
};


// =========================================================================
// BLOCO 4: SEQUÊNCIA DE BOOT E AUTENTICAÇÃO (RESOLVE A TELA PRETA)
// =========================================================================

// Boot sequence
(async ()=> {
    await ensureShop();
    // Você pode chamar migrateLocalToFirestore() aqui se precisar
    
    log('Firebase integration ready. Monitoring auth state...');

    // MONITORAMENTO OBRIGATÓRIO: Esta função decide o que mostrar
    onAuthStateChanged(auth, async (user) => {
    // Garante que nenhum painel fique sobreposto durante a inicialização
    el('loginCard').style.display = 'none';
    el('screen-root').style.display = 'none';
    el('adminPanel').style.display = 'none';
    el('clientPanel').style.display = 'none';
        if (user) {
            // USUÁRIO ESTÁ LOGADO
            const userRoleSnap = await getDoc(doc(db, "users", user.uid));
            let role = 'client'; 
            if (userRoleSnap.exists() && userRoleSnap.data().role === 'admin') {
                 role = 'admin';
            }
            
            if (role === 'admin') {
                loginAdminAfterAuth(user.email, role);
            } else {
                loginClientAfterAuth(user.email, role);
            }

        } else {
            // NENHUM USUÁRIO LOGADO - MOSTRA A TELA DE LOGIN
            log('[AUTH] Nenhum usuário logado. Exibindo tela de login.');
            
            // FORÇA A EXIBIÇÃO DA CAIXA DE LOGIN
            document.getElementById('loginCard').style.display = 'flex'; 
            document.getElementById('screen-root').style.display = 'flex';
            el('app').style.display = 'none'; 
            showLoginAnimation(); // Executa sua animação de login
        }
    });
})();

// Expose helpers for debugging on window
window.__LS_FIREBASE = { db, auth, ensureShop, SHOP_ID };

</script>




</body></html>