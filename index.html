<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistema de Compra</title>
<style>
:root{
  --bg:#050505;
  --panel:#0b0d10;
  --muted:#9aa1a6;
  --accent:#00b894;
  --glass: rgba(255,255,255,0.03);
  --glass-strong: rgba(255,255,255,0.06);
  --card:#070809;
  --text:#e6eef1;
  --input-bg:#0a0b0c;
  --select-bg:#0c0d0e;
  --danger:#ff7675;
  --warning:#fdcb6e;
  --info:#74b9ff;
  --success:#00b894;
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg) 0%, #0a0a0b 100%);color:var(--text);-webkit-font-smoothing:antialiased}
a{color:inherit}
.container{max-width:1100px;margin:18px auto;padding:16px}
.center-screen{min-height:80vh;display:flex;align-items:center;justify-content:center}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#006266);display:flex;align-items:center;justify-content:center;font-weight:800;color:#021}
.title{font-size:20px;font-weight:700}
.small-muted{font-size:12px;color:var(--muted)}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;transition:transform .12s,background .12s}
.btn:hover{transform:translateY(-2px);background:rgba(255,255,255,0.02)}
.btn.primary{background:linear-gradient(90deg,var(--accent),#00d68f);color:#021;border:none}
.btn.secondary{background:linear-gradient(90deg,var(--info),#0984e3);color:#021;border:none}
.btn.warning{background:linear-gradient(90deg,var(--warning),#e17055);color:#021;border:none}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.005));border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03)}
.grid{display:grid;grid-template-columns:360px 1fr;gap:16px}
.input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:var(--input-bg);color:var(--text);font-size:14px}
.select-dark{background:var(--select-bg);color:var(--text)}
.form-row{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;align-items:center}
.products-list{margin-top:10px;display:flex;flex-direction:column;gap:10px;max-height:420px;overflow:auto;padding-right:6px}
.product{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:10px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02);cursor:pointer}
.pname{font-weight:700}
.meta{font-size:13px;color:var(--muted)}
.product-actions{display:flex;gap:8px;align-items:center}
.icon-btn{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;cursor:pointer;color:var(--muted);font-weight:700}
.statlist{display:flex;gap:8px;align-items:stretch;margin-bottom:10px}
.stat{background:rgba(255,255,255,0.01);padding:10px;border-radius:10px;text-align:center;flex:1;border:1px solid rgba(255,255,255,0.02)}
.stat .num{font-weight:800;font-size:18px}
.footer{margin-top:16px;display:flex;gap:10px;align-items:center;justify-content:flex-end;color:var(--muted)}
.limit-badge{background:rgba(255,255,255,0.02);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.02);font-size:13px}
.empty{opacity:0.7;color:var(--muted);padding:14px;text-align:center}

/* LOGIN */
.login-wrap{width:100%;max-width:440px;padding:22px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.04);backdrop-filter:blur(8px)}
.login-title{font-size:22px;font-weight:800;margin-bottom:4px}
.subtle{color:var(--muted);font-size:13px;margin-bottom:10px}

/* MODAL / DETAILS (ensure black bg) */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:60}
.modal{width:calc(100% - 40px);max-width:720px;background:#000;border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 22px 60px rgba(0,0,0,0.8);color:var(--text)}
.tx-table{width:100%;border-collapse:collapse;margin-top:8px}
.tx-table th{color:var(--muted);text-align:left;padding:8px;font-size:13px}
.tx-table td{padding:8px;border-top:1px dashed rgba(255,255,255,0.03);font-size:14px}

/* topbar */
.topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
.user-pill{display:flex;gap:10px;align-items:center;background:rgba(255,255,255,0.02);padding:8px;border-radius:999px;border:1px solid rgba(255,255,255,0.03)}
.role-admin{color:var(--accent);font-weight:800}
.role-view{color:var(--muted);font-weight:700}
.role-client{color:var(--info);font-weight:700}

/* small touches */
.small{font-size:13px;color:var(--muted)}
.sep{height:1px;background:rgba(255,255,255,0.02);margin:12px 0;border-radius:2px}

/* status badges */
.status-badge{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
.status-pending{background:rgba(253,203,110,0.1);color:var(--warning)}
.status-preparing{background:rgba(116,185,255,0.1);color:var(--info)}
.status-shipping{background:rgba(0,184,148,0.1);color:var(--accent)}
.status-delivered{background:rgba(0,184,148,0.2);color:var(--accent);border:1px solid rgba(0,184,148,0.3)}
.status-cancelled{background:rgba(255,118,117,0.1);color:var(--danger)}
.status-paid{background:rgba(0,184,148,0.3);color:var(--success);border:1px solid rgba(0,184,148,0.5)}

/* responsive */
@media(max-width:900px){
  .grid{grid-template-columns:1fr}
  .logo{width:46px;height:46px}
  .product{padding:10px}
  .center-screen{padding:18px}
  .container{padding:12px}
  .header{flex-direction:column;align-items:stretch;gap:8px}
  .topbar{flex-direction:column;align-items:stretch;gap:8px}
  .user-pill{justify-content:center;margin-top:8px}
  .form-row{flex-direction:column;align-items:stretch}
  .form-row > *{width:100% !important}
  .statlist{flex-direction:column}
  .product{flex-direction:column;align-items:stretch;gap:8px}
  .product-actions{justify-content:center}
  .modal{width:95%;margin:10px;padding:14px}
}

/* fix selects in chrome mobile */
select::-ms-expand { display: none; }

/* tabs */
.tabs{display:flex;gap:4px;background:rgba(255,255,255,0.01);padding:4px;border-radius:10px;margin-bottom:12px}
.tab{flex:1;text-align:center;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700;transition:background .12s}
.tab.active{background:rgba(255,255,255,0.05)}

/* purchase history */
.history-item{padding:10px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02);margin-bottom:8px}
.history-date{font-size:12px;color:var(--muted)}
.history-products{margin-top:6px}
.history-product{display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px}

/* admin access */
.admin-access{display:none;margin-top:12px}

/* phone input */
.phone-input{font-family:monospace;letter-spacing:1px}

/* mobile optimizations */
@media(max-width:480px){
  .login-wrap{padding:16px;margin:10px}
  .btn{padding:12px 16px;font-size:14px}
  .input,select,textarea{padding:12px;font-size:16px}
  .products-list{max-height:300px}
}
</style>
</head>
<body>

<div class="center-screen" id="screen-root">
  <!-- LOGIN -->
  <div class="login-wrap card" id="loginCard" style="transform:translateY(8px);opacity:0;transition:all .45s cubic-bezier(.2,.9,.25,1)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div class="brand"><div class="logo">SC</div><div><div class="login-title">Sistema de Compra</div><div class="subtle">Escolha seu tipo de acesso</div></div></div>
      <div class="small-muted">Profissional • Dark</div>
    </div>

    <div class="tabs" id="loginTabs">
      <div class="tab active" data-tab="client">Cliente</div>
      <div class="tab" data-tab="admin">Administrador</div>
    </div>

    <!-- Client Login -->
    <div id="clientLogin" style="display:block">
      <div style="margin-top:8px">
        <label class="small">E-mail</label>
        <input id="clientEmail" class="input" placeholder="seu-email@gmail.com" autocomplete="email"/>
      </div>
      <div style="margin-top:8px">
        <label class="small">Senha</label>
        <input id="clientPassword" type="password" class="input" placeholder="Sua senha" autocomplete="current-password"/>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="clientLoginBtn" class="btn primary">Entrar como Cliente</button>
        <button id="clientRegisterBtn" class="btn">Registrar Cliente</button>
      </div>
      <div class="small" style="margin-top:10px;color:var(--muted)">É necessário fazer login para realizar compras.</div>
    </div>

    <!-- Admin Login -->
    <div id="adminLogin" style="display:none">
      <div id="adminAccessForm">
        <div style="margin-top:8px">
          <label class="small">Senha de Acesso ADM</label>
          <input id="adminAccessPassword" type="password" class="input" placeholder="Digite a senha de acesso ADM"/>
        </div>
        <div style="margin-top:10px">
          <button id="adminAccessBtn" class="btn primary">Acessar Painel ADM</button>
        </div>
      </div>

      <div id="adminLoginForm" class="admin-access">
        <div style="margin-top:8px">
          <label class="small">E-mail</label>
          <input id="loginEmail" class="input" placeholder="seu-email@gmail.com" autocomplete="email"/>
        </div>
        <div style="margin-top:8px">
          <label class="small">Senha</label>
          <input id="loginPassword" type="password" class="input" placeholder="Sua senha" autocomplete="current-password"/>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="loginBtn" class="btn primary">Entrar</button>
          <button id="registerBtn" class="btn">Registrar ADM</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- APP (hidden until login) -->
<div class="container" id="app" style="display:none;opacity:0;transition:opacity .35s">
  <div class="header card topbar">
    <div style="display:flex;align-items:center;gap:12px">
      <div class="brand"><div class="logo">SC</div><div><div class="title">Sistema de Compra</div><div class="small-muted" id="userSubtitle">Gestão personalizada por e-mail</div></div></div>
    </div>
    <div style="display:flex;align-items:center;gap:10px">
      <div class="user-pill" id="userInfo"><div class="small-muted">Logado como:</div><div id="userEmail" style="font-weight:800"></div><div id="userRole" class="role-view"></div></div>
      <div style="display:flex;gap:8px">
        <button id="logoutBtn" class="btn">Sair</button>
      </div>
    </div>
  </div>

  <div id="notice" style="display:none;margin-bottom:10px" class="card small-muted"></div>

  <!-- Admin Panel -->
  <div id="adminPanel" style="display:none">
    <div class="grid">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div><strong>Cadastro / Estoque</strong><div class="small-muted">Máx 10 itens por conta</div></div>
          <div class="limit-badge" id="countBadge">0 / 10</div>
        </div>

        <div class="label">Nome do produto</div>
        <input id="pName" class="input" placeholder="Ex: Produto X" />

        <div class="form-row">
          <div style="flex:1">
            <div class="label">Preço de custo (R$)</div>
            <input id="pCost" class="input" type="number" min="0" step="0.01" />
          </div>
          <div style="width:140px">
            <div class="label">Preço de venda (R$)</div>
            <input id="pPrice" class="input" type="number" min="0" step="0.01" />
          </div>
        </div>

        <div class="form-row" style="margin-top:8px">
          <div style="flex:1">
            <div class="label">Quantidade</div>
            <input id="pQty" class="input" type="number" min="0" step="1" />
          </div>
          <div style="width:140px">
            <div class="label">Categoria</div>
            <input id="pCat" class="input" />
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="addProduct" class="btn primary">Adicionar / Atualizar</button>
          <button id="resetForm" class="btn">Limpar</button>
        </div>

        <div class="sep"></div>

        <div class="label">Operação rápida (entrada / saída)</div>
        <div class="form-row">
          <select id="opProduct" class="input select-dark"><option value="">Escolha um produto</option></select>
          <input id="opQty" class="input" type="number" placeholder="Qtd" />
          <select id="opType" class="input select-dark"><option value="in">Entrada</option><option value="out">Saída</option></select>
          <button id="applyOp" class="btn">Aplicar</button>
        </div>

        <div class="small-muted" style="margin-top:10px">As ações de modificar/excluir são restritas a administradores. Visualizadores apenas leem dados.</div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <strong>Painel</strong>
          <div class="small-muted">Visualização por conta</div>
        </div>

        <div class="statlist">
          <div class="stat"><div class="small-muted">Total em estoque</div><div class="num" id="totalStock">R$ 0,00</div></div>
          <div class="stat"><div class="small-muted">Total vendido</div><div class="num" id="totalSold">R$ 0,00</div></div>
          <div class="stat"><div class="small-muted">Lucro total</div><div class="num" id="totalProfit">R$ 0,00</div></div>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Produtos</strong>
          <div class="small-muted">Toque para ver detalhes</div>
        </div>

        <div class="products-list" id="productsList">
          <div class="empty">Nenhum produto cadastrado.</div>
        </div>

        <div style="margin-top:12px">
          <strong>Transações</strong>
          <table class="tx-table" id="txTable"><thead><tr><th>Data</th><th>Produto</th><th>Tipo</th><th>Qtd</th><th>Detalhes</th></tr></thead><tbody><tr><td colspan="5" class="empty">Sem transações.</td></tr></tbody></table>
        </div>

        <div class="footer">Dados salvos localmente por e-mail • Máx 10 itens</div>
      </div>
    </div>

    <!-- Orders Management -->
    <div class="card" style="margin-top:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <strong>Gerenciamento de Pedidos</strong>
        <div class="small-muted">Controle de pedidos dos clientes</div>
      </div>

      <div class="products-list" id="ordersList">
        <div class="empty">Nenhum pedido realizado.</div>
      </div>
    </div>
  </div>

  <!-- Client Panel -->
  <div id="clientPanel" style="display:none">
    <!-- Shopping Area -->
    <div id="shoppingArea">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <strong>Loja Virtual</strong>
          <div class="small-muted">Escolha seus produtos</div>
        </div>

        <div class="products-list" id="storeProductsList">
          <div class="empty">Nenhum produto disponível.</div>
        </div>

        <div class="sep"></div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <strong>Carrinho de Compras</strong>
          <div class="small-muted" id="cartCount">0 itens</div>
        </div>

        <div id="cartItems" class="products-list">
          <div class="empty">Carrinho vazio</div>
        </div>

        <div style="margin-top:12px">
          <button id="checkoutBtn" class="btn primary" style="width:100%">Finalizar Pedido</button>
        </div>
      </div>
    </div>

    <!-- Order Tracking -->
    <div id="orderTracking" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <strong>Meus Pedidos</strong>
          <div class="small-muted">Acompanhe seus pedidos</div>
        </div>

        <div class="products-list" id="clientOrdersList">
          <div class="empty">Nenhum pedido realizado.</div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="backToShopBtn" class="btn secondary">Voltar para a Loja</button>
          <button id="viewHistoryBtn" class="btn">Ver Histórico Completo</button>
        </div>
      </div>
    </div>

    <!-- Purchase History -->
    <div id="purchaseHistory" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <strong>Histórico de Compras</strong>
          <div class="small-muted">Todos os seus pedidos realizados</div>
        </div>

        <div id="historyList">
          <div class="empty">Nenhuma compra realizada.</div>
        </div>

        <div style="margin-top:12px">
          <button id="backToTrackingBtn" class="btn secondary">Voltar para Pedidos</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="modalRoot" style="display:none"></div>

<script>
// Helper & state
const el = id => document.getElementById(id);
const MAX_ITEMS = 10;
let state = { 
  email: null, 
  role: 'viewer', 
  data: { products: [], transactions: [] }, 
  adminEmail: null,
  clientData: { orders: [], purchaseHistory: [] },
  cart: [],
  currentView: 'shop'
};

// utils
function money(v){ return 'R$ ' + Number(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2}); }
function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
function storageKey(email){ return 'sc_user_' + email.toLowerCase(); }
function clientStorageKey(email){ return 'sc_client_' + email.toLowerCase(); }
function ordersStorageKey(){ return 'sc_orders'; }

// Format phone number in real-time
function formatPhoneNumber(value) {
  const numbers = value.replace(/\D/g, '');
  const limited = numbers.slice(0, 11);
  
  if (limited.length <= 10) {
    return limited.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
  } else {
    return limited.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
  }
}

// Phone input formatter
function setupPhoneInput(inputId) {
  const input = el(inputId);
  if (!input) return;
  
  input.addEventListener('input', function(e) {
    const cursorPosition = e.target.selectionStart;
    const formatted = formatPhoneNumber(e.target.value);
    e.target.value = formatted;
    const extraChars = formatted.length - e.target.value.length;
    e.target.setSelectionRange(cursorPosition + extraChars, cursorPosition + extraChars);
  });
  
  input.addEventListener('keydown', function(e) {
    if (!/[\d]|Backspace|Delete|ArrowLeft|ArrowRight|Tab/.test(e.key)) {
      e.preventDefault();
    }
  });
}

// Login animations
function showLoginAnimation(){ const card = el('loginCard'); setTimeout(()=>{ card.style.transform='translateY(0)'; card.style.opacity='1'; },80); }
showLoginAnimation();

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    
    const tabType = tab.getAttribute('data-tab');
    if (tabType === 'admin') {
      el('adminLogin').style.display = 'block';
      el('clientLogin').style.display = 'none';
    } else {
      el('adminLogin').style.display = 'none';
      el('clientLogin').style.display = 'block';
    }
  });
});

// Admin access password
el('adminAccessBtn').onclick = () => {
  const password = el('adminAccessPassword').value;
  if (password === 'Lucãoadm') {
    el('adminAccessForm').style.display = 'none';
    el('adminLoginForm').style.display = 'block';
    
    const adminKeys = Object.keys(localStorage).filter(key => key.startsWith('sc_user_'));
    if (adminKeys.length > 0) {
      el('registerBtn').style.display = 'none';
    }
  } else {
    alert('Senha de acesso ADM incorreta!');
  }
};

// Login handlers
el('loginBtn').onclick = ()=> { 
  const email = el('loginEmail').value.trim(); 
  const password = el('loginPassword').value;
  if(!email || !email.includes('@')) return alert('Digite um e-mail válido.'); 
  if(!password) return alert('Digite sua senha.');
  loginAdmin(email, password); 
}

el('registerBtn').onclick = ()=> { 
  const email = el('loginEmail').value.trim(); 
  const password = el('loginPassword').value;
  if(!email || !email.includes('@')) return alert('Digite um e-mail válido.'); 
  if(!password) return alert('Digite uma senha.');
  registerAdmin(email, password); 
}

el('clientLoginBtn').onclick = ()=> { 
  const email = el('clientEmail').value.trim(); 
  const password = el('clientPassword').value;
  if(!email || !email.includes('@')) return alert('Digite um e-mail válido.'); 
  if(!password) return alert('Digite sua senha.');
  loginClient(email, password); 
}

el('clientRegisterBtn').onclick = ()=> { 
  const email = el('clientEmail').value.trim(); 
  const password = el('clientPassword').value;
  if(!email || !email.includes('@')) return alert('Digite um e-mail válido.'); 
  if(!password) return alert('Digite uma senha.');
  registerClient(email, password); 
}

// View History Button
el('viewHistoryBtn').onclick = () => {
  state.currentView = 'history';
  renderClientViews();
};

// Admin registration and login
function registerAdmin(email, password) {
  const key = storageKey(email);
  if(localStorage.getItem(key)) {
    return alert('Este e-mail já está registrado.');
  }
  
  const adminData = {
    email: email.toLowerCase(),
    password: password,
    data: { products: [], transactions: [] },
    registeredAt: Date.now()
  };
  
  localStorage.setItem(key, JSON.stringify(adminData));
  alert('Conta de administrador registrada com sucesso!');
  el('registerBtn').style.display = 'none';
}

function loginAdmin(email, password) {
  const key = storageKey(email);
  const stored = localStorage.getItem(key);
  
  if(!stored) {
    return alert('E-mail não encontrado. Registre-se primeiro.');
  }
  
  try {
    const adminData = JSON.parse(stored);
    if(adminData.password !== password) {
      return alert('Senha incorreta.');
    }
    
    state.email = email.toLowerCase();
    const parts = state.email.split('@');
    const local = parts[0];
    state.role = /adm/i.test(local) ? 'admin' : 'viewer';
    state.adminEmail = state.role === 'admin' ? state.email : deriveAdminEmail(state.email);
    state.data = adminData.data || { products: [], transactions: [] };
    
    loadOrders();
    
    el('userEmail').textContent = state.email;
    el('userRole').textContent = state.role === 'admin' ? ' • ADM' : '';
    el('userRole').className = state.role === 'admin' ? 'role-admin' : 'role-view';
    el('userSubtitle').textContent = 'Painel de Administração';
    
    document.getElementById('loginCard').style.display='none';
    document.getElementById('screen-root').style.display='none';
    const app = el('app'); app.style.display = 'block';
    el('adminPanel').style.display = 'block';
    el('clientPanel').style.display = 'none';
    
    setTimeout(()=> app.style.opacity = '1',40);
    applyRoleRestrictions();
    renderAll();
    
    if(state.role === 'viewer'){
      el('notice').style.display = 'block';
      el('notice').textContent = `Você está visualizando o estoque do administrador ${state.adminEmail} (modo leitura).`;
    } else {
      el('notice').style.display = 'none';
    }
  } catch(e) {
    alert('Erro ao fazer login: ' + e.message);
  }
}

// Client registration and login
function registerClient(email, password) {
  const key = clientStorageKey(email);
  if(localStorage.getItem(key)) {
    return alert('Este e-mail já está registrado.');
  }
  
  const clientData = {
    email: email.toLowerCase(),
    password: password,
    orders: [],
    purchaseHistory: [],
    registeredAt: Date.now()
  };
  
  localStorage.setItem(key, JSON.stringify(clientData));
  alert('Conta de cliente registrada com sucesso!');
}

function loginClient(email, password) {
  const key = clientStorageKey(email);
  const stored = localStorage.getItem(key);
  
  if(!stored) {
    return alert('E-mail não encontrado. Registre-se primeiro.');
  }
  
  try {
    const clientData = JSON.parse(stored);
    if(clientData.password !== password) {
      return alert('Senha incorreta.');
    }
    
    state.email = email.toLowerCase();
    state.role = 'client';
    state.clientData = clientData;
    
    loadAdminProducts();
    
    el('userEmail').textContent = state.email;
    el('userRole').textContent = ' • Cliente';
    el('userRole').className = 'role-client';
    el('userSubtitle').textContent = 'Área do Cliente';
    
    document.getElementById('loginCard').style.display='none';
    document.getElementById('screen-root').style.display='none';
    const app = el('app'); app.style.display = 'block';
    el('adminPanel').style.display = 'none';
    el('clientPanel').style.display = 'block';
    
    setTimeout(()=> app.style.opacity = '1',40);
    renderClientViews();
    
  } catch(e) {
    alert('Erro ao fazer login: ' + e.message);
  }
}

function loadAdminProducts() {
  const adminKeys = Object.keys(localStorage).filter(key => key.startsWith('sc_user_'));
  if (adminKeys.length > 0) {
    const adminData = JSON.parse(localStorage.getItem(adminKeys[0]));
    if (adminData && adminData.data) {
      state.data = adminData.data;
    }
  }
}

function loadOrders() {
  const ordersKey = ordersStorageKey();
  const stored = localStorage.getItem(ordersKey);
  if (stored) {
    try {
      state.orders = JSON.parse(stored);
    } catch(e) {
      state.orders = [];
    }
  } else {
    state.orders = [];
  }
}

function saveOrders() {
  const ordersKey = ordersStorageKey();
  localStorage.setItem(ordersKey, JSON.stringify(state.orders));
}

function deriveAdminEmail(email){
  const parts = email.split('@');
  const local = parts[0] || '';
  const domain = parts[1] || 'example.com';
  if(/adm/i.test(local)) return email.toLowerCase();
  const adminLocal = local + 'adm';
  return (adminLocal + '@' + domain).toLowerCase();
}

// LOGOUT
el('logoutBtn').onclick = ()=> {
  if(!confirm('Deseja sair?')) return;
  state = { 
    email: null, 
    role: 'viewer', 
    data: { products: [], transactions: [] }, 
    adminEmail: null,
    clientData: { orders: [], purchaseHistory: [] },
    cart: [],
    currentView: 'shop'
  };
  el('app').style.display = 'none'; 
  el('app').style.opacity = '0';
  document.getElementById('screen-root').style.display='flex';
  document.getElementById('loginCard').style.display='block';
  
  el('adminAccessForm').style.display = 'block';
  el('adminLoginForm').style.display = 'none';
  el('adminAccessPassword').value = '';
  el('loginEmail').value = '';
  el('loginPassword').value = '';
  
  showLoginAnimation();
}

// Persistence
function saveState(){
  if(!state.email) return;
  
  if(state.role === 'admin' || state.role === 'viewer') {
    const key = storageKey(state.role === 'admin' ? state.email : state.adminEmail);
    const stored = localStorage.getItem(key);
    if (stored) {
      const adminData = JSON.parse(stored);
      adminData.data = state.data;
      localStorage.setItem(key, JSON.stringify(adminData));
    }
  } else if (state.role === 'client') {
    const key = clientStorageKey(state.email);
    const stored = localStorage.getItem(key);
    if (stored) {
      const clientData = JSON.parse(stored);
      clientData.orders = state.clientData.orders;
      clientData.purchaseHistory = state.clientData.purchaseHistory;
      localStorage.setItem(key, JSON.stringify(clientData));
    }
  }
}

// UI helpers
function updateCounts(){ el('countBadge').textContent = state.data.products.length + ' / ' + MAX_ITEMS; }
function refreshProductSelect(){
  const sel = el('opProduct');
  sel.innerHTML = '<option value="">Escolha um produto</option>';
  state.data.products.forEach(p=>{
    const opt = document.createElement('option'); opt.value = p.id; opt.textContent = p.name; sel.appendChild(opt);
  });
}

function renderProducts(){
  const container = el('productsList');
  container.innerHTML = '';
  if(state.data.products.length === 0){
    container.innerHTML = '<div class="empty">Nenhum produto cadastrado.</div>';
    renderTransactions();
    updateCounts();
    return;
  }
  state.data.products.forEach(p=>{
    const div = document.createElement('div');
    div.className = 'product';
    div.onclick = ()=> openProductModal(p.id);
    const left = document.createElement('div');
    left.style.display='flex'; left.style.flexDirection='column';
    const name = document.createElement('div'); name.className='pname'; name.textContent = p.name;
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `${p.qty} un • Custo ${money(p.cost)} • Venda ${money(p.price)} • Lucro unit ${money(p.price - p.cost)}`;
    left.appendChild(name); left.appendChild(meta);
    const actions = document.createElement('div'); actions.className='product-actions';
    if(state.role === 'admin'){
      const editBtn = document.createElement('button'); editBtn.className='icon-btn'; editBtn.textContent='Editar';
      editBtn.onclick = (ev)=>{ ev.stopPropagation(); loadIntoForm(p.id); };
      const delBtn = document.createElement('button'); delBtn.className='icon-btn'; delBtn.textContent='Excluir';
      delBtn.onclick = (ev)=>{ ev.stopPropagation(); if(confirm('Excluir produto?')){ deleteProduct(p.id); } };
      actions.appendChild(editBtn); actions.appendChild(delBtn);
    } else {
      const info = document.createElement('div'); info.className='small-muted'; info.textContent='Apenas visualização';
      actions.appendChild(info);
    }
    div.appendChild(left); div.appendChild(actions);
    container.appendChild(div);
  });
  renderTransactions();
  updateCounts();
}

function renderTransactions(){
  const tbody = el('txTable').querySelector('tbody');
  if(state.data.transactions.length === 0){
    tbody.innerHTML = '<tr><td colspan="5" class="empty">Sem transações.</td></tr>';
    updateSummary();
    return;
  }
  tbody.innerHTML = '';
  state.data.transactions.slice().reverse().forEach(tx=>{
    const tr = document.createElement('tr');
    const d = new Date(tx.ts).toLocaleString();
    tr.innerHTML = `<td>${d}</td><td>${tx.productName}</td><td>${tx.type==='in'?'Entrada':'Saída'}</td><td>${tx.qty}</td><td>${tx.details||''}</td>`;
    tbody.appendChild(tr);
  });
  updateSummary();
}

function updateSummary(){
  const stock = state.data.products.reduce((acc,p)=> acc + (p.qty * p.cost), 0);
  const sold = state.data.transactions.filter(tx=>tx.type==='out').reduce((acc,tx)=> acc + (tx.qty * tx.price), 0);
  const profit = state.data.transactions.filter(tx=>tx.type==='out').reduce((acc,tx)=> acc + (tx.qty * (tx.price - tx.cost)), 0);
  el('totalStock').textContent = money(stock);
  el('totalSold').textContent = money(sold);
  el('totalProfit').textContent = money(profit);
}

function applyRoleRestrictions(){
  const isAdmin = state.role === 'admin';
  const inputs = ['pName','pCost','pPrice','pQty','pCat','opProduct','opQty','opType'];
  inputs.forEach(id=> el(id).disabled = !isAdmin);
  el('addProduct').disabled = !isAdmin;
  el('resetForm').disabled = !isAdmin;
  el('applyOp').disabled = !isAdmin;
}

function renderAll(){
  renderProducts();
  refreshProductSelect();
}

// Product form
let editingId = null;
el('addProduct').onclick = ()=> {
  if(state.data.products.length >= MAX_ITEMS && !editingId){
    alert(`Limite de ${MAX_ITEMS} produtos atingido.`);
    return;
  }
  const name = el('pName').value.trim();
  const cost = parseFloat(el('pCost').value) || 0;
  const price = parseFloat(el('pPrice').value) || 0;
  const qty = parseInt(el('pQty').value) || 0;
  const cat = el('pCat').value.trim();
  if(!name) return alert('Digite um nome.');
  if(cost < 0 || price < 0 || qty < 0) return alert('Valores não podem ser negativos.');
  if(price < cost) return alert('Preço de venda não pode ser menor que o custo.');
  
  if(editingId){
    const idx = state.data.products.findIndex(p=> p.id === editingId);
    if(idx >= 0){
      state.data.products[idx] = { ...state.data.products[idx], name, cost, price, qty, cat };
      addTransaction('edit', qty, `Produto atualizado: ${name}`, name, cost, price);
    }
    editingId = null;
  } else {
    const id = uid();
    state.data.products.push({ id, name, cost, price, qty, cat });
    addTransaction('in', qty, `Novo produto: ${name}`, name, cost, price);
  }
  saveState();
  renderAll();
  resetForm();
}

el('resetForm').onclick = resetForm;
function resetForm(){
  el('pName').value = '';
  el('pCost').value = '';
  el('pPrice').value = '';
  el('pQty').value = '';
  el('pCat').value = '';
  editingId = null;
  el('addProduct').textContent = 'Adicionar / Atualizar';
}

function loadIntoForm(id){
  const p = state.data.products.find(p=> p.id === id);
  if(!p) return;
  el('pName').value = p.name;
  el('pCost').value = p.cost;
  el('pPrice').value = p.price;
  el('pQty').value = p.qty;
  el('pCat').value = p.cat || '';
  editingId = id;
  el('addProduct').textContent = 'Atualizar Produto';
}

function deleteProduct(id){
  const idx = state.data.products.findIndex(p=> p.id === id);
  if(idx < 0) return;
  const p = state.data.products[idx];
  state.data.products.splice(idx,1);
  addTransaction('out', p.qty, `Produto excluído: ${p.name}`, p.name, p.cost, p.price);
  saveState();
  renderAll();
}

// Operations
el('applyOp').onclick = ()=> {
  const pid = el('opProduct').value;
  const qty = parseInt(el('opQty').value) || 0;
  const type = el('opType').value;
  if(!pid) return alert('Escolha um produto.');
  if(qty <= 0) return alert('Digite uma quantidade válida.');
  
  const p = state.data.products.find(p=> p.id === pid);
  if(!p) return alert('Produto não encontrado.');
  
  if(type === 'out' && p.qty < qty) return alert('Estoque insuficiente.');
  
  p.qty += type === 'in' ? qty : -qty;
  addTransaction(type, qty, `Operação: ${type==='in'?'Entrada':'Saída'} de ${qty} un`, p.name, p.cost, p.price);
  saveState();
  renderAll();
  el('opQty').value = '';
}

function addTransaction(type, qty, details, productName, cost, price){
  state.data.transactions.push({
    ts: Date.now(),
    type, qty, details, productName, cost, price
  });
}

// Modal
function openProductModal(id){
  const p = state.data.products.find(p=> p.id === id);
  if(!p) return;
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop';
  modal.onclick = (ev)=> { if(ev.target === modal) modal.remove(); };
  modal.innerHTML = `
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <strong>Detalhes do Produto</strong>
        <button class="icon-btn" onclick="this.closest('.modal-backdrop').remove()">✕</button>
      </div>
      <div><strong>Nome:</strong> ${p.name}</div>
      <div><strong>Categoria:</strong> ${p.cat || 'Nenhuma'}</div>
      <div><strong>Quantidade:</strong> ${p.qty} un</div>
      <div><strong>Preço de custo:</strong> ${money(p.cost)}</div>
      <div><strong>Preço de venda:</strong> ${money(p.price)}</div>
      <div><strong>Lucro unitário:</strong> ${money(p.price - p.cost)}</div>
      <div><strong>Lucro total potencial:</strong> ${money((p.price - p.cost) * p.qty)}</div>
      <div class="sep"></div>
      <div class="small-muted">ID: ${p.id}</div>
    </div>
  `;
  document.body.appendChild(modal);
}

// Client Views
function renderClientViews() {
  if (state.currentView === 'shop') {
    renderStoreProducts();
    renderCart();
    el('shoppingArea').style.display = 'block';
    el('orderTracking').style.display = 'none';
    el('purchaseHistory').style.display = 'none';
  } else if (state.currentView === 'tracking') {
    renderClientOrders();
    el('shoppingArea').style.display = 'none';
    el('orderTracking').style.display = 'block';
    el('purchaseHistory').style.display = 'none';
  } else if (state.currentView === 'history') {
    renderPurchaseHistory();
    el('shoppingArea').style.display = 'none';
    el('orderTracking').style.display = 'none';
    el('purchaseHistory').style.display = 'block';
  }
}

function renderStoreProducts() {
  const container = el('storeProductsList');
  container.innerHTML = '';
  
  if(state.data.products.length === 0){
    container.innerHTML = '<div class="empty">Nenhum produto disponível.</div>';
    return;
  }
  
  state.data.products.forEach(p => {
    if (p.qty <= 0) return;
    
    const div = document.createElement('div');
    div.className = 'product';
    
    const left = document.createElement('div');
    left.style.display = 'flex'; 
    left.style.flexDirection = 'column';
    
    const name = document.createElement('div'); 
    name.className = 'pname'; 
    name.textContent = p.name;
    
    const meta = document.createElement('div'); 
    meta.className = 'meta'; 
    meta.textContent = `${p.qty} disponíveis • ${money(p.price)}`;
    
    left.appendChild(name); 
    left.appendChild(meta);
    
    const actions = document.createElement('div'); 
    actions.className = 'product-actions';
    
    const qtyInput = document.createElement('input');
    qtyInput.type = 'number';
    qtyInput.min = 1;
    qtyInput.max = p.qty;
    qtyInput.value = 1;
    qtyInput.style.width = '60px';
    qtyInput.className = 'input';
    
    const addBtn = document.createElement('button');
    addBtn.className = 'btn primary';
    addBtn.textContent = 'Adicionar';
    addBtn.onclick = () => {
      const quantity = parseInt(qtyInput.value) || 1;
      if (quantity < 1) return alert('Quantidade inválida');
      if (quantity > p.qty) return alert('Quantidade indisponível');
      
      addToCart(p, quantity);
    };
    
    actions.appendChild(qtyInput);
    actions.appendChild(addBtn);
    
    div.appendChild(left);
    div.appendChild(actions);
    container.appendChild(div);
  });
}

function addToCart(product, quantity) {
  const existingItem = state.cart.find(item => item.product.id === product.id);
  
  if (existingItem) {
    if (existingItem.quantity + quantity > product.qty) {
      return alert('Quantidade indisponível');
    }
    existingItem.quantity += quantity;
  } else {
    state.cart.push({
      product: { ...product },
      quantity: quantity
    });
  }
  
  renderCart();
}

function renderCart() {
  const container = el('cartItems');
  const countEl = el('cartCount');
  
  if (state.cart.length === 0) {
    container.innerHTML = '<div class="empty">Carrinho vazio</div>';
    countEl.textContent = '0 itens';
    return;
  }
  
  container.innerHTML = '';
  let totalItems = 0;
  
  state.cart.forEach((item, index) => {
    totalItems += item.quantity;
    
    const div = document.createElement('div');
    div.className = 'product';
    
    const left = document.createElement('div');
    left.style.display = 'flex'; 
    left.style.flexDirection = 'column';
    
    const name = document.createElement('div'); 
    name.className = 'pname'; 
    name.textContent = item.product.name;
    
    const meta = document.createElement('div'); 
    meta.className = 'meta'; 
    meta.textContent = `${item.quantity} × ${money(item.product.price)} = ${money(item.product.price * item.quantity)}`;
    
    left.appendChild(name); 
    left.appendChild(meta);
    
    const actions = document.createElement('div'); 
    actions.className = 'product-actions';
    
    const removeBtn = document.createElement('button');
    removeBtn.className = 'icon-btn';
    removeBtn.textContent = 'Remover';
    removeBtn.onclick = () => {
      state.cart.splice(index, 1);
      renderCart();
    };
    
    actions.appendChild(removeBtn);
    
    div.appendChild(left);
    div.appendChild(actions);
    container.appendChild(div);
  });
  
  countEl.textContent = `${totalItems} ${totalItems === 1 ? 'item' : 'itens'}`;
}

// Checkout - COMPLETELY REWRITTEN
el('checkoutBtn').onclick = () => {
  if (state.cart.length === 0) return alert('Carrinho vazio');
  openCheckoutModal();
};

function openCheckoutModal() {
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop';
  modal.id = 'checkoutModal';
  
  let total = 0;
  state.cart.forEach(item => {
    total += item.product.price * item.quantity;
  });
  
  modal.innerHTML = `
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <strong>Finalizar Pedido</strong>
        <button class="icon-btn" id="closeCheckoutModal">✕</button>
      </div>
      
      <div style="margin-bottom:12px">
        <strong>Resumo do Pedido:</strong>
        <div style="margin-top:8px">
          ${state.cart.map(item => `
            <div style="display:flex;justify-content:space-between;margin-bottom:4px">
              <span>${item.product.name} (${item.quantity}x)</span>
              <span>${money(item.product.price * item.quantity)}</span>
            </div>
          `).join('')}
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:8px;border-top:1px solid rgba(255,255,255,0.1);padding-top:8px">
          <strong>Total:</strong>
          <strong>${money(total)}</strong>
        </div>
      </div>
      
      <div class="sep"></div>
      
      <div style="margin-bottom:12px">
        <strong>Dados de Entrega</strong>
      </div>
      
      <div style="display:grid;gap:8px">
        <div>
          <label class="small">Nome completo</label>
          <input id="checkoutName" class="input" placeholder="Seu nome completo">
        </div>
        <div>
          <label class="small">Telefone</label>
          <input id="checkoutPhone" class="input phone-input" placeholder="(11) 99999-9999" maxlength="15">
        </div>
        <div>
          <label class="small">Endereço completo</label>
          <textarea id="checkoutAddress" class="input" placeholder="Rua, número, bairro, cidade, estado, CEP" rows="3"></textarea>
        </div>
      </div>
      
      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="confirmOrderBtn" class="btn primary" style="flex:1">Confirmar Pedido</button>
        <button class="btn" id="cancelCheckoutBtn">Cancelar</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Setup phone formatter
  setupPhoneInput('checkoutPhone');
  
  // Add event listeners directly to the buttons
  const closeBtn = document.getElementById('closeCheckoutModal');
  const cancelBtn = document.getElementById('cancelCheckoutBtn');
  const confirmBtn = document.getElementById('confirmOrderBtn');
  
  if (closeBtn) {
    closeBtn.onclick = function() {
      modal.remove();
    };
  }
  
  if (cancelBtn) {
    cancelBtn.onclick = function() {
      modal.remove();
    };
  }
  
  if (confirmBtn) {
    confirmBtn.onclick = function() {
      const name = document.getElementById('checkoutName').value.trim();
      const phone = document.getElementById('checkoutPhone').value.trim();
      const address = document.getElementById('checkoutAddress').value.trim();
      
      if (!name || !phone || !address) {
        alert('Preencha todos os dados de entrega');
        return;
      }
      
      if (phone.replace(/\D/g, '').length < 10) {
        alert('Digite um telefone válido com DDD');
        return;
      }
      
      // Call confirmOrder function
      confirmOrder(name, phone, address);
      modal.remove();
    };
  }
}

function confirmOrder(name, phone, address) {
  console.log('Confirmando pedido...'); // Debug log
  
  // Create order
  const order = {
    id: uid(),
    clientEmail: state.email,
    clientName: name,
    clientPhone: phone,
    clientAddress: address,
    items: state.cart.map(item => ({
      productId: item.product.id,
      productName: item.product.name,
      quantity: item.quantity,
      unitPrice: item.product.price,
      unitCost: item.product.cost,
      totalPrice: item.product.price * item.quantity,
      totalCost: item.product.cost * item.quantity,
      profit: (item.product.price - item.product.cost) * item.quantity
    })),
    total: state.cart.reduce((sum, item) => sum + (item.product.price * item.quantity), 0),
    totalCost: state.cart.reduce((sum, item) => sum + (item.product.cost * item.quantity), 0),
    totalProfit: state.cart.reduce((sum, item) => sum + ((item.product.price - item.product.cost) * item.quantity), 0),
    status: 'pending',
    createdAt: Date.now(),
    updatedAt: Date.now()
  };
  
  console.log('Pedido criado:', order); // Debug log
  
  // Add to client orders and purchase history
  if (state.role === 'client') {
    state.clientData.orders.push(order);
    
    const historyEntry = {
      orderId: order.id,
      date: order.createdAt,
      items: order.items,
      total: order.total,
      status: order.status
    };
    state.clientData.purchaseHistory.push(historyEntry);
    
    const key = clientStorageKey(state.email);
    localStorage.setItem(key, JSON.stringify(state.clientData));
    console.log('Dados do cliente salvos'); // Debug log
  }
  
  // Add to global orders
  loadOrders();
  state.orders.push(order);
  saveOrders();
  console.log('Pedidos globais salvos'); // Debug log
  
  // Clear cart
  state.cart = [];
  
  alert('Pedido realizado com sucesso! Aguarde a confirmação do pagamento.');
  renderCart();
  
  // Switch to order tracking
  state.currentView = 'tracking';
  renderClientViews();
  
  console.log('Pedido finalizado com sucesso'); // Debug log
}

// Order tracking for clients
function renderClientOrders() {
  const container = el('clientOrdersList');
  container.innerHTML = '';
  
  let orders = [];
  
  if (state.role === 'client') {
    orders = state.clientData.orders || [];
  }
  
  if (orders.length === 0) {
    container.innerHTML = '<div class="empty">Nenhum pedido realizado.</div>';
    return;
  }
  
  orders.sort((a, b) => b.createdAt - a.createdAt).forEach(order => {
    const div = document.createElement('div');
    div.className = 'product';
    
    const left = document.createElement('div');
    left.style.display = 'flex'; 
    left.style.flexDirection = 'column';
    left.style.flex = '1';
    
    const topRow = document.createElement('div');
    topRow.style.display = 'flex'; 
    topRow.style.justifyContent = 'space-between';
    topRow.style.alignItems = 'flex-start';
    
    const orderInfo = document.createElement('div');
    const name = document.createElement('div'); 
    name.className = 'pname'; 
    name.textContent = `Pedido #${order.id.slice(-6)}`;
    
    const date = document.createElement('div'); 
    date.className = 'meta'; 
    date.textContent = new Date(order.createdAt).toLocaleString();
    
    orderInfo.appendChild(name);
    orderInfo.appendChild(date);
    
    const status = document.createElement('div');
    status.className = `status-badge status-${getStatusClass(order.status)}`;
    status.textContent = getStatusText(order.status);
    
    topRow.appendChild(orderInfo);
    topRow.appendChild(status);
    
    const items = document.createElement('div');
    items.className = 'meta';
    items.style.marginTop = '8px';
    items.textContent = order.items.map(item => `${item.quantity}x ${item.productName}`).join(', ');
    
    const total = document.createElement('div');
    total.className = 'meta';
    total.style.marginTop = '4px';
    total.textContent = `Total: ${money(order.total)}`;
    
    const address = document.createElement('div');
    address.className = 'meta';
    address.style.marginTop = '4px';
    address.textContent = `Entregar em: ${order.clientAddress}`;
    
    left.appendChild(topRow);
    left.appendChild(items);
    left.appendChild(total);
    left.appendChild(address);
    
    div.appendChild(left);
    container.appendChild(div);
  });
}

// Purchase History
function renderPurchaseHistory() {
  const container = el('historyList');
  container.innerHTML = '';
  
  if (!state.clientData.purchaseHistory || state.clientData.purchaseHistory.length === 0) {
    container.innerHTML = '<div class="empty">Nenhuma compra realizada.</div>';
    return;
  }
  
  const historyByDate = {};
  state.clientData.purchaseHistory.forEach(entry => {
    const date = new Date(entry.date).toLocaleDateString('pt-BR');
    if (!historyByDate[date]) {
      historyByDate[date] = [];
    }
    historyByDate[date].push(entry);
  });
  
  Object.keys(historyByDate).sort((a, b) => new Date(b) - new Date(a)).forEach(date => {
    const dateHeader = document.createElement('div');
    dateHeader.className = 'pname';
    dateHeader.textContent = date;
    dateHeader.style.marginTop = '16px';
    dateHeader.style.marginBottom = '8px';
    container.appendChild(dateHeader);
    
    historyByDate[date].forEach(entry => {
      const historyItem = document.createElement('div');
      historyItem.className = 'history-item';
      
      const topRow = document.createElement('div');
      topRow.style.display = 'flex';
      topRow.style.justifyContent = 'space-between';
      topRow.style.alignItems = 'center';
      topRow.style.marginBottom = '8px';
      
      const orderId = document.createElement('div');
      orderId.className = 'small';
      orderId.textContent = `Pedido #${entry.orderId.slice(-6)}`;
      
      const status = document.createElement('div');
      status.className = `status-badge status-${getStatusClass(entry.status)}`;
      status.textContent = getStatusText(entry.status);
      
      topRow.appendChild(orderId);
      topRow.appendChild(status);
      
      const productsList = document.createElement('div');
      productsList.className = 'history-products';
      
      entry.items.forEach(item => {
        const productDiv = document.createElement('div');
        productDiv.className = 'history-product';
        
        const productName = document.createElement('span');
        productName.textContent = `${item.quantity}x ${item.productName}`;
        
        const productTotal = document.createElement('span');
        productTotal.textContent = money(item.totalPrice);
        
        productDiv.appendChild(productName);
        productDiv.appendChild(productTotal);
        productsList.appendChild(productDiv);
      });
      
      const totalDiv = document.createElement('div');
      totalDiv.className = 'history-product';
      totalDiv.style.borderTop = '1px solid rgba(255,255,255,0.1)';
      totalDiv.style.paddingTop = '4px';
      totalDiv.style.marginTop = '4px';
      totalDiv.style.fontWeight = 'bold';
      
      const totalLabel = document.createElement('span');
      totalLabel.textContent = 'Total:';
      
      const totalValue = document.createElement('span');
      totalValue.textContent = money(entry.total);
      
      totalDiv.appendChild(totalLabel);
      totalDiv.appendChild(totalValue);
      productsList.appendChild(totalDiv);
      
      historyItem.appendChild(topRow);
      historyItem.appendChild(productsList);
      container.appendChild(historyItem);
    });
  });
}

function getStatusClass(status) {
  const statusMap = {
    'pending': 'pending',
    'paid': 'paid',
    'preparing': 'preparing',
    'shipping': 'shipping',
    'delivered': 'delivered',
    'cancelled': 'cancelled'
  };
  return statusMap[status] || 'pending';
}

function getStatusText(status) {
  const statusMap = {
    'pending': 'Pendente',
    'paid': 'Pago',
    'preparing': 'Em preparação',
    'shipping': 'A caminho',
    'delivered': 'Entregue',
    'cancelled': 'Cancelado'
  };
  return statusMap[status] || 'Pendente';
}

// Back to shop button
el('backToShopBtn').onclick = () => {
  state.currentView = 'shop';
  renderClientViews();
};

// Back to tracking from history
el('backToTrackingBtn').onclick = () => {
  state.currentView = 'tracking';
  renderClientViews();
};

// Orders Management for Admin - FIXED PAID STATUS
function renderOrdersManagement() {
  const container = el('ordersList');
  container.innerHTML = '';
  
  loadOrders();
  
  if (state.orders.length === 0) {
    container.innerHTML = '<div class="empty">Nenhum pedido realizado.</div>';
    return;
  }
  
  state.orders.sort((a, b) => b.createdAt - a.createdAt).forEach(order => {
    const div = document.createElement('div');
    div.className = 'product';
    
    const left = document.createElement('div');
    left.style.display = 'flex'; 
    left.style.flexDirection = 'column';
    left.style.flex = '1';
    
    const topRow = document.createElement('div');
    topRow.style.display = 'flex'; 
    topRow.style.justifyContent = 'space-between';
    topRow.style.alignItems = 'flex-start';
    
    const orderInfo = document.createElement('div');
    const name = document.createElement('div'); 
    name.className = 'pname'; 
    name.textContent = `Pedido #${order.id.slice(-6)} - ${order.clientName}`;
    
    const contact = document.createElement('div'); 
    contact.className = 'meta'; 
    contact.textContent = `${order.clientEmail} • ${order.clientPhone}`;
    
    const date = document.createElement('div'); 
    date.className = 'meta'; 
    date.textContent = new Date(order.createdAt).toLocaleString();
    
    const profit = document.createElement('div');
    profit.className = 'meta';
    profit.style.color = 'var(--accent)';
    profit.textContent = `Lucro: ${money(order.totalProfit)}`;
    
    orderInfo.appendChild(name);
    orderInfo.appendChild(contact);
    orderInfo.appendChild(date);
    orderInfo.appendChild(profit);
    
    const statusControl = document.createElement('div');
    statusControl.style.display = 'flex';
    statusControl.style.alignItems = 'center';
    statusControl.style.gap = '8px';
    
    const statusSelect = document.createElement('select');
    statusSelect.className = 'input select-dark';
    statusSelect.innerHTML = `
      <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pendente</option>
      <option value="paid" ${order.status === 'paid' ? 'selected' : ''}>Pago</option>
      <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Em preparação</option>
      <option value="shipping" ${order.status === 'shipping' ? 'selected' : ''}>A caminho</option>
      <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Entregue</option>
      <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelado</option>
    `;
    
    statusSelect.onchange = () => {
      const newStatus = statusSelect.value;
      const oldStatus = order.status;
      
      order.status = newStatus;
      order.updatedAt = Date.now();
      
      // Handle profit updates when status changes to "paid"
      if (newStatus === 'paid' && oldStatus !== 'paid') {
        // Add profit transaction immediately when marked as paid
        addTransaction('sale', 0, `Pagamento confirmado: Pedido #${order.id.slice(-6)} - ${order.clientName}`, 'Venda', order.totalCost, order.total);
        console.log('Lucro adicionado ao marcar como Pago');
      }
      
      // Handle stock updates only when delivered
      if (newStatus === 'delivered' && oldStatus !== 'delivered') {
        order.items.forEach(item => {
          const product = state.data.products.find(p => p.id === item.productId);
          if (product) {
            product.qty -= item.quantity;
            addTransaction('out', item.quantity, `Entrega realizada: ${item.productName} para ${order.clientName}`, item.productName, item.unitCost, item.unitPrice);
          }
        });
      }
      
      saveOrders();
      saveState();
      renderAll(); // Refresh the dashboard
      
      // Update client's order status
      const clientKey = clientStorageKey(order.clientEmail);
      const clientData = localStorage.getItem(clientKey);
      if (clientData) {
        try {
          const client = JSON.parse(clientData);
          const clientOrder = client.orders.find(o => o.id === order.id);
          if (clientOrder) {
            clientOrder.status = order.status;
            clientOrder.updatedAt = order.updatedAt;
            
            const historyEntry = client.purchaseHistory.find(h => h.orderId === order.id);
            if (historyEntry) {
              historyEntry.status = order.status;
            }
            
            localStorage.setItem(clientKey, JSON.stringify(client));
          }
        } catch(e) {
          console.error('Error updating client order:', e);
        }
      }
    };
    
    statusControl.appendChild(statusSelect);
    
    topRow.appendChild(orderInfo);
    topRow.appendChild(statusControl);
    
    const items = document.createElement('div');
    items.className = 'meta';
    items.style.marginTop = '8px';
    items.textContent = order.items.map(item => `${item.quantity}x ${item.productName} (${money(item.unitPrice)} cada)`).join(', ');
    
    const total = document.createElement('div');
    total.className = 'meta';
    total.style.marginTop = '4px';
    total.textContent = `Total: ${money(order.total)} (Custo: ${money(order.totalCost)})`;
    
    const address = document.createElement('div');
    address.className = 'meta';
    address.style.marginTop = '4px';
    address.textContent = `Endereço: ${order.clientAddress}`;
    
    left.appendChild(topRow);
    left.appendChild(items);
    left.appendChild(total);
    left.appendChild(address);
    
    div.appendChild(left);
    container.appendChild(div);
  });
}

// Initialize
window.onload = () => {
  if (state.role === 'admin') {
    renderOrdersManagement();
  }
};

// Update renderAll to include orders management
const originalRenderAll = renderAll;
renderAll = function() {
  originalRenderAll();
  if (state.role === 'admin') {
    renderOrdersManagement();
  }
};
</script>
</body>
</html>