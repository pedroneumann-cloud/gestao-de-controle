<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Compra</title>
  <style>
:root{
  --bg:#050505;
  --panel:#0b0d10;
  --muted:#9aa1a6;
  --accent:#00b894;
  --glass: rgba(255,255,255,0.03);
  --glass-strong: rgba(255,255,255,0.06);
  --card:#070809;
  --text:#e6eef1;
  --input-bg:#0a0b0c;
  --select-bg:#0c0d0e;
  --danger:#ff7675;
  --warning:#fdcb6e;
  --info:#74b9ff;
  --success:#00b894;
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg) 0%, #0a0a0b 100%);color:var(--text);-webkit-font-smoothing:antialiased}
a{color:inherit}
.container{max-width:1100px;margin:18px auto;padding:16px}
.center-screen{min-height:80vh;display:flex;align-items:center;justify-content:center}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#006266);display:flex;align-items:center;justify-content:center;font-weight:800;color:#021}
.title{font-size:20px;font-weight:700}
.small-muted{font-size:12px;color:var(--muted)}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;transition:transform .12s,background .12s}
.btn:hover{transform:translateY(-2px);background:rgba(255,255,255,0.02)}
.btn.primary{background:linear-gradient(90deg,var(--accent),#00d68f);color:#021;border:none}
.btn.secondary{background:linear-gradient(90deg,var(--info),#0984e3);color:#021;border:none}
.btn.warning{background:linear-gradient(90deg,var(--warning),#e17055);color:#021;border:none}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.005));border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03)}
.grid{display:grid;grid-template-columns:360px 1fr;gap:16px}
.input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:var(--input-bg);color:var(--text);font-size:14px}
.select-dark{background:var(--select-bg);color:var(--text)}
.form-row{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;align-items:center}
.products-list{margin-top:10px;display:flex;flex-direction:column;gap:10px;max-height:420px;overflow:auto;padding-right:6px}
.product{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:10px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02);cursor:pointer}
.pname{font-weight:700}
.meta{font-size:13px;color:var(--muted)}
.product-actions{display:flex;gap:8px;align-items:center}
.icon-btn{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;cursor:pointer;color:var(--muted);font-weight:700}
.statlist{display:flex;gap:8px;align-items:stretch;margin-bottom:10px}
.stat{background:rgba(255,255,255,0.01);padding:10px;border-radius:10px;text-align:center;flex:1;border:1px solid rgba(255,255,255,0.02)}
.stat .num{font-weight:800;font-size:18px}
.footer{margin-top:16px;display:flex;gap:10px;align-items:center;justify-content:flex-end;color:var(--muted)}
.limit-badge{background:rgba(255,255,255,0.02);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.02);font-size:13px}
.empty{opacity:0.7;color:var(--muted);padding:14px;text-align:center}

/* LOGIN */
.login-wrap{width:100%;max-width:440px;padding:22px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.04);backdrop-filter:blur(8px)}
.login-title{font-size:22px;font-weight:800;margin-bottom:4px}
.subtle{color:var(--muted);font-size:13px;margin-bottom:10px}

/* MODAL / DETAILS */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:60}
.modal{width:calc(100% - 40px);max-width:720px;background:#000;border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 22px 60px rgba(0,0,0,0.8);color:var(--text)}
.tx-table{width:100%;border-collapse:collapse;margin-top:8px}
.tx-table th{color:var(--muted);text-align:left;padding:8px;font-size:13px}
.tx-table td{padding:8px;border-top:1px dashed rgba(255,255,255,0.03);font-size:14px}

/* topbar */
.topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
.user-pill{display:flex;gap:10px;align-items:center;background:rgba(255,255,255,0.02);padding:8px;border-radius:999px;border:1px solid rgba(255,255,255,0.03)}
.role-admin{color:var(--accent);font-weight:800}
.role-view{color:var(--muted);font-weight:700}
.role-client{color:var(--info);font-weight:700}

/* small touches */
.small{font-size:13px;color:var(--muted)}
.sep{height:1px;background:rgba(255,255,255,0.02);margin:12px 0;border-radius:2px}

/* status badges */
.status-badge{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
.status-pending{background:rgba(253,203,110,0.1);color:var(--warning)}
.status-preparing{background:rgba(116,185,255,0.1);color:var(--info)}
.status-shipping{background:rgba(0,184,148,0.1);color:var(--accent)}
.status-delivered{background:rgba(0,184,148,0.2);color:var(--accent);border:1px solid rgba(0,184,148,0.3)}
.status-cancelled{background:rgba(255,118,117,0.1);color:var(--danger)}
.status-paid{background:rgba(0,184,148,0.3);color:var(--success);border:1px solid rgba(0,184,148,0.5)}

/* responsive */
@media(max-width:900px){
  .grid{grid-template-columns:1fr}
  .logo{width:46px;height:46px}
  .product{padding:10px}
  .center-screen{padding:18px}
  .container{padding:12px}
  .header{flex-direction:column;align-items:stretch;gap:8px}
  .topbar{flex-direction:column;align-items:stretch;gap:8px}
  .user-pill{justify-content:center;margin-top:8px}
  .form-row{flex-direction:column;align-items:stretch}
  .form-row > *{width:100% !important}
  .statlist{flex-direction:column}
  .product{flex-direction:column;align-items:stretch;gap:8px}
  .product-actions{justify-content:center}
  .modal{width:95%;margin:10px;padding:14px}
}

/* fix selects in chrome mobile */
select::-ms-expand { display: none; }

/* tabs */
.tabs{display:flex;gap:4px;background:rgba(255,255,255,0.01);padding:4px;border-radius:10px;margin-bottom:12px}
.tab{flex:1;text-align:center;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700;transition:background .12s}
.tab.active{background:rgba(255,255,255,0.05)}

/* purchase history */
.history-item{padding:10px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02);margin-bottom:8px}
.history-date{font-size:12px;color:var(--muted)}
.history-products{margin-top:6px}
.history-product{display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px}

/* admin access */
.admin-access{display:none;margin-top:12px}

/* phone input */
.phone-input{font-family:monospace;letter-spacing:1px}

/* mobile optimizations */
@media(max-width:480px){
  .login-wrap{padding:16px;margin:10px}
  .btn{padding:12px 16px;font-size:14px}
  .input,select,textarea{padding:12px;font-size:16px}
  .products-list{max-height:300px}
}

/* ===== Centralização + Não sobrepor painéis ===== */
#screen-root {
  position: fixed;
  inset: 0;
  display: flex !important;
  align-items: center;
  justify-content: center;
  z-index: 1 !important; /* atrás do app */
}
#loginCard {
  position: relative;
  display: flex !important;
  flex-direction: column;
  align-items: stretch;
  justify-content: center;
  max-width: 440px;
  width: 100%;
  margin: auto;
  opacity: 0;
  transform: translateY(-10px);
  transition: 0.25s ease-out;
  z-index: 1 !important;
}
#app {
  z-index: 10 !important; /* App sempre à frente do login */
  position: relative;
}
/* Quando escondemos o login, garantimos que ele não capture eventos */
.hidden-login {
  display: none !important;
  visibility: hidden !important;
  pointer-events: none !important;
}
  </style>
</head>
<body>
  <div class="center-screen" id="screen-root">
    <!-- LOGIN -->
    <div class="login-wrap card" id="loginCard">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="brand">
          <div class="logo">SC</div>
          <div>
            <div class="login-title">Sistema de Compra</div>
            <div class="subtle">Escolha seu tipo de acesso</div>
          </div>
        </div>
        <div class="small-muted">Profissional • Dark</div>
      </div>

      <div class="tabs" id="loginTabs">
        <div class="tab active" data-tab="client">Cliente</div>
        <div class="tab" data-tab="admin">Administrador</div>
      </div>

      <!-- Client Login -->
      <div id="clientLogin" style="display:block">
        <div style="margin-top:8px">
          <label class="small">E-mail</label>
          <input id="clientEmail" class="input" placeholder="seu-email@gmail.com" autocomplete="email">
        </div>
        <div style="margin-top:8px">
          <label class="small">Senha</label>
          <input id="clientPassword" type="password" class="input" placeholder="Sua senha" autocomplete="current-password">
        </div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="clientLoginBtn" class="btn primary">Entrar como Cliente</button>
          <button id="clientRegisterBtn" class="btn">Registrar Cliente</button>
        </div>
        <div class="small" style="margin-top:10px;color:var(--muted)">É necessário fazer login para realizar compras.</div>
      </div>

      <!-- Admin Login -->
      <div id="adminLogin" style="display:none">
        <div id="adminAccessForm">
          <div style="margin-top:8px">
            <label class="small">Senha de Acesso ADM</label>
            <input id="adminAccessPassword" type="password" class="input" placeholder="Digite a senha de acesso ADM">
          </div>
          <div style="margin-top:10px">
            <button id="adminAccessBtn" class="btn primary">Acessar Painel ADM</button>
          </div>
        </div>

        <div id="adminLoginForm" class="admin-access">
          <div style="margin-top:8px">
            <label class="small">E-mail</label>
            <input id="loginEmail" class="input" placeholder="seu-email@gmail.com" autocomplete="email">
          </div>
          <div style="margin-top:8px">
            <label class="small">Senha</label>
            <input id="loginPassword" type="password" class="input" placeholder="Sua senha" autocomplete="current-password">
          </div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="loginBtn" class="btn primary">Entrar</button>
            <button id="registerBtn" class="btn">Registrar ADM</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div class="container" id="app" style="display:none;opacity:0;transition:opacity .35s">
    <div class="header card topbar">
      <div style="display:flex;align-items:center;gap:12px">
        <div class="brand"><div class="logo">SC</div><div><div class="title">Sistema de Compra</div><div class="small-muted" id="userSubtitle">Gestão personalizada por e-mail</div></div></div>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <div class="user-pill" id="userInfo"><div class="small-muted">Logado como:</div><div id="userEmail" style="font-weight:800"></div><div id="userRole" class="role-view"></div></div>
        <div style="display:flex;gap:8px">
          <button id="logoutBtn" class="btn">Sair</button>
        </div>
      </div>
    </div>

    <div id="notice" style="display:none;margin-bottom:10px" class="card small-muted"></div>

    <!-- Painel ADM -->
    <div id="adminPanel" style="display:none">
      <div class="grid">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div><strong>Cadastro / Estoque</strong><div class="small-muted">Máx 10 itens por conta</div></div>
            <div class="limit-badge" id="countBadge">0 / 10</div>
          </div>

          <div class="label">Nome do produto</div>
          <input id="pName" class="input" placeholder="Ex: Produto X">

          <div class="form-row">
            <div style="flex:1">
              <div class="label">Preço de custo (R$)</div>
              <input id="pCost" class="input" type="number" min="0" step="0.01">
            </div>
            <div style="width:140px">
              <div class="label">Preço de venda (R$)</div>
              <input id="pPrice" class="input" type="number" min="0" step="0.01">
            </div>
          </div>

          <div class="form-row" style="margin-top:8px">
            <div style="flex:1">
              <div class="label">Quantidade</div>
              <input id="pQty" class="input" type="number" min="0" step="1">
            </div>
            <div style="width:140px">
              <div class="label">Categoria</div>
              <input id="pCat" class="input">
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="addProduct" class="btn primary">Adicionar / Atualizar</button>
            <button id="resetForm" class="btn">Limpar</button>
          </div>

          <div class="sep"></div>

          <div class="label">Operação rápida (entrada / saída)</div>
          <div class="form-row">
            <select id="opProduct" class="input select-dark"><option value="">Escolha um produto</option></select>
            <input id="opQty" class="input" type="number" placeholder="Qtd">
            <select id="opType" class="input select-dark"><option value="in">Entrada</option><option value="out">Saída</option></select>
            <button id="applyOp" class="btn">Aplicar</button>
          </div>

          <div class="small-muted" style="margin-top:10px">As ações de modificar/excluir são restritas a administradores. Visualizadores apenas leem dados.</div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <strong>Painel</strong>
            <div class="small-muted">Visualização por conta</div>
          </div>

          <div class="statlist">
            <div class="stat"><div class="small-muted">Total em estoque</div><div class="num" id="totalStock">R$ 0,00</div></div>
            <div class="stat"><div class="small-muted">Total vendido</div><div class="num" id="totalSold">R$ 0,00</div></div>
            <div class="stat"><div class="small-muted">Lucro total</div><div class="num" id="totalProfit">R$ 0,00</div></div>
          </div>

          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>Produtos</strong>
            <div class="small-muted">Toque para ver detalhes</div>
          </div>

          <div class="products-list" id="productsList">
            <div class="empty">Nenhum produto cadastrado.</div>
          </div>

          <div style="margin-top:12px">
            <strong>Transações</strong>
            <table class="tx-table" id="txTable">
              <thead><tr><th>Data</th><th>Produto</th><th>Tipo</th><th>Qtd</th><th>Detalhes</th></tr></thead>
              <tbody><tr><td colspan="5" class="empty">Sem transações.</td></tr></tbody>
            </table>
          </div>

          <div class="footer">Dados salvos localmente por e-mail • Máx 10 itens</div>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <strong>Gerenciamento de Pedidos</strong>
          <div class="small-muted">Controle de pedidos dos clientes</div>
        </div>

        <div class="products-list" id="ordersList">
          <div class="empty">Nenhum pedido realizado.</div>
        </div>
      </div>
    </div>

    <!-- Painel Cliente -->
    <div id="clientPanel" style="display:none">
      <div id="shoppingArea">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <strong>Loja Virtual</strong>
            <div class="small-muted">Escolha seus produtos</div>
          </div>

          <div class="products-list" id="storeProductsList">
            <div class="empty">Nenhum produto disponível.</div>
          </div>

          <div class="sep"></div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <strong>Carrinho de Compras</strong>
            <div class="small-muted" id="cartCount">0 itens</div>
          </div>

          <div id="cartItems" class="products-list">
            <div class="empty">Carrinho vazio</div>
          </div>

          <div style="margin-top:12px">
            <button id="checkoutBtn" class="btn primary" style="width:100%">Finalizar Pedido</button>
          </div>
        </div>
      </div>

      <div id="orderTracking" style="display:none">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <strong>Meus Pedidos</strong>
            <div class="small-muted">Acompanhe seus pedidos</div>
          </div>

          <div class="products-list" id="clientOrdersList">
            <div class="empty">Nenhum pedido realizado.</div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="backToShopBtn" class="btn secondary">Voltar para a Loja</button>
            <button id="viewHistoryBtn" class="btn">Ver Histórico Completo</button>
          </div>
        </div>
      </div>

      <div id="purchaseHistory" style="display:none">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <strong>Histórico de Compras</strong>
            <div class="small-muted">Todos os seus pedidos realizados</div>
          </div>

          <div id="historyList">
            <div class="empty">Nenhuma compra realizada.</div>
          </div>

          <div style="margin-top:12px">
            <button id="backToTrackingBtn" class="btn secondary">Voltar para Pedidos</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="modalRoot" style="display:none"></div>

  <script type="module">


    // =========================================================================
// GERENCIAMENTO DE PRODUTOS E ESTOQUE
// =========================================================================

// Referências do Firestore
const productsCollection = 'products';
const transactionsCollection = 'transactions';

// Elementos UI
const elements = {
    pName: el('pName'),
    pCost: el('pCost'),
    pPrice: el('pPrice'),
    pQty: el('pQty'),
    pCat: el('pCat'),
    addProduct: el('addProduct'),
    resetForm: el('resetForm'),
    opProduct: el('opProduct'),
    opQty: el('opQty'),
    opType: el('opType'),
    applyOp: el('applyOp'),
    productsList: el('productsList'),
    txTable: el('txTable'),
    totalStock: el('totalStock'),
    totalSold: el('totalSold'),
    totalProfit: el('totalProfit'),
    countBadge: el('countBadge')
};

// Estado global
let currentEditingProductId = null;
let allProducts = [];

// ===== FUNÇÕES PRINCIPAIS =====

// Adicionar ou atualizar produto
async function addOrUpdateProduct() {
    const user = auth.currentUser;
    if (!user) return alert('Usuário não autenticado');
    
    const name = elements.pName.value.trim();
    const cost = parseFloat(elements.pCost.value);
    const price = parseFloat(elements.pPrice.value);
    const quantity = parseInt(elements.pQty.value);
    const category = elements.pCat.value.trim();
    
    // Validações
    if (!name) return alert('Nome do produto é obrigatório');
    if (isNaN(cost) || cost < 0) return alert('Custo inválido');
    if (isNaN(price) || price < 0) return alert('Preço de venda inválido');
    if (isNaN(quantity) || quantity < 0) return alert('Quantidade inválida');
    if (price < cost) return alert('Preço de venda não pode ser menor que custo');
    
    try {
        const productId = currentEditingProductId || `${user.uid}_${Date.now()}`;
        const productData = {
            id: productId,
            name,
            cost,
            price,
            quantity,
            category: category || 'Geral',
            userId: user.uid,
            userEmail: user.email,
            lastUpdated: serverTimestamp(),
            createdAt: currentEditingProductId ? undefined : serverTimestamp()
        };
        
        await setDoc(doc(db, productsCollection, productId), productData);
        
        // Registrar transação
        if (!currentEditingProductId) {
            await addTransaction('create', productId, name, quantity, `Produto criado: ${name}`);
        } else {
            await addTransaction('update', productId, name, quantity, `Produto atualizado: ${name}`);
        }
        
        alert(currentEditingProductId ? 'Produto atualizado!' : 'Produto adicionado!');
        resetProductForm();
        loadProducts();
        
    } catch (error) {
        console.error('Erro ao salvar produto:', error);
        alert('Erro ao salvar produto: ' + error.message);
    }
}

// Operação rápida de estoque
async function applyQuickOperation() {
    const productId = elements.opProduct.value;
    const quantity = parseInt(elements.opQty.value);
    const operationType = elements.opType.value;
    
    if (!productId) return alert('Selecione um produto');
    if (isNaN(quantity) || quantity <= 0) return alert('Quantidade inválida');
    
    const product = allProducts.find(p => p.id === productId);
    if (!product) return alert('Produto não encontrado');
    
    try {
        let newQuantity = product.quantity;
        let transactionType = '';
        
        if (operationType === 'in') {
            newQuantity += quantity;
            transactionType = 'entrada';
        } else {
            if (product.quantity < quantity) {
                return alert('Estoque insuficiente');
            }
            newQuantity -= quantity;
            transactionType = 'saída';
        }
        
        // Atualizar produto
        await setDoc(doc(db, productsCollection, productId), {
            ...product,
            quantity: newQuantity,
            lastUpdated: serverTimestamp()
        }, { merge: true });
        
        // Registrar transação
        await addTransaction(
            operationType === 'in' ? 'stock_in' : 'stock_out',
            productId,
            product.name,
            quantity,
            `${operationType === 'in' ? 'Entrada' : 'Saída'} de estoque: ${quantity} unidades`
        );
        
        alert(`Estoque atualizado! ${transactionType} de ${quantity} unidades`);
        elements.opQty.value = '';
        loadProducts();
        
    } catch (error) {
        console.error('Erro na operação:', error);
        alert('Erro na operação: ' + error.message);
    }
}

// Carregar produtos
async function loadProducts() {
    const user = auth.currentUser;
    if (!user) return;
    
    try {
        // Buscar produtos do usuário atual
        const q = query(
            collection(db, productsCollection),
            where('userId', '==', user.uid)
        );
        
        const querySnapshot = await getDocs(q);
        allProducts = [];
        const productsHtml = [];
        
        querySnapshot.forEach((docSnap) => {
            const product = docSnap.data();
            allProducts.push(product);
            
            const profit = (product.price - product.cost) * product.quantity;
            productsHtml.push(`
                <div class="product" onclick="editProduct('${product.id}')">
                    <div>
                        <div class="pname">${product.name}</div>
                        <div class="meta">${product.category} • Estoque: ${product.quantity}</div>
                        <div class="meta">Custo: R$ ${product.cost.toFixed(2)} • Venda: R$ ${product.price.toFixed(2)}</div>
                    </div>
                    <div class="product-actions">
                        <button class="icon-btn" onclick="event.stopPropagation(); deleteProduct('${product.id}')">🗑️</button>
                    </div>
                </div>
            `);
        });
        
        elements.productsList.innerHTML = productsHtml.length > 0 
            ? productsHtml.join('') 
            : '<div class="empty">Nenhum produto cadastrado.</div>';
        
        // Atualizar dropdown de operações rápidas
        updateOperationsDropdown();
        
        // Atualizar estatísticas
        updateStatistics();
        
        // Atualizar badge de contagem
        elements.countBadge.textContent = `${allProducts.length} / 10`;
        
    } catch (error) {
        console.error('Erro ao carregar produtos:', error);
        elements.productsList.innerHTML = '<div class="empty">Erro ao carregar produtos</div>';
    }
}

// Carregar transações
async function loadTransactions() {
    const user = auth.currentUser;
    if (!user) return;
    
    try {
        const q = query(
            collection(db, transactionsCollection),
            where('userId', '==', user.uid),
            orderBy('timestamp', 'desc'),
            limit(10)
        );
        
        const querySnapshot = await getDocs(q);
        const transactionsHtml = [];
        
        querySnapshot.forEach((docSnap) => {
            const tx = docSnap.data();
            const date = tx.timestamp?.toDate?.() || new Date();
            transactionsHtml.push(`
                <tr>
                    <td>${date.toLocaleDateString()}</td>
                    <td>${tx.productName}</td>
                    <td>${getTransactionTypeLabel(tx.type)}</td>
                    <td>${tx.quantity}</td>
                    <td>${tx.description || ''}</td>
                </tr>
            `);
        });
        
        const tbody = elements.txTable.querySelector('tbody');
        tbody.innerHTML = transactionsHtml.length > 0 
            ? transactionsHtml.join('') 
            : '<tr><td colspan="5" class="empty">Sem transações.</td></tr>';
        
    } catch (error) {
        console.error('Erro ao carregar transações:', error);
    }
}

// ===== FUNÇÕES AUXILIARES =====

function editProduct(productId) {
    const product = allProducts.find(p => p.id === productId);
    if (!product) return;
    
    elements.pName.value = product.name;
    elements.pCost.value = product.cost;
    elements.pPrice.value = product.price;
    elements.pQty.value = product.quantity;
    elements.pCat.value = product.category;
    
    currentEditingProductId = productId;
    elements.addProduct.textContent = 'Atualizar Produto';
}

async function deleteProduct(productId) {
    if (!confirm('Tem certeza que deseja excluir este produto?')) return;
    
    try {
        const product = allProducts.find(p => p.id === productId);
        await deleteDoc(doc(db, productsCollection, productId));
        
        // Registrar transação de exclusão
        await addTransaction('delete', productId, product.name, 0, `Produto excluído: ${product.name}`);
        
        alert('Produto excluído!');
        loadProducts();
        
    } catch (error) {
        console.error('Erro ao excluir produto:', error);
        alert('Erro ao excluir produto: ' + error.message);
    }
}

function resetProductForm() {
    elements.pName.value = '';
    elements.pCost.value = '';
    elements.pPrice.value = '';
    elements.pQty.value = '';
    elements.pCat.value = '';
    currentEditingProductId = null;
    elements.addProduct.textContent = 'Adicionar / Atualizar';
}

function updateOperationsDropdown() {
    elements.opProduct.innerHTML = '<option value="">Escolha um produto</option>';
    allProducts.forEach(product => {
        elements.opProduct.innerHTML += `<option value="${product.id}">${product.name} (Estoque: ${product.quantity})</option>`;
    });
}

function updateStatistics() {
    let totalStockValue = 0;
    let totalSoldValue = 0;
    let totalProfitValue = 0;
    
    allProducts.forEach(product => {
        const stockValue = product.cost * product.quantity;
        const potentialProfit = (product.price - product.cost) * product.quantity;
        
        totalStockValue += stockValue;
        totalProfitValue += potentialProfit;
    });
    
    elements.totalStock.textContent = `R$ ${totalStockValue.toFixed(2)}`;
    elements.totalSold.textContent = `R$ ${totalSoldValue.toFixed(2)}`;
    elements.totalProfit.textContent = `R$ ${totalProfitValue.toFixed(2)}`;
}

async function addTransaction(type, productId, productName, quantity, description) {
    const user = auth.currentUser;
    if (!user) return;
    
    try {
        await setDoc(doc(db, transactionsCollection, `${user.uid}_${Date.now()}`), {
            type,
            productId,
            productName,
            quantity,
            description,
            userId: user.uid,
            userEmail: user.email,
            timestamp: serverTimestamp()
        });
        
        loadTransactions();
        
    } catch (error) {
        console.error('Erro ao registrar transação:', error);
    }
}

function getTransactionTypeLabel(type) {
    const types = {
        'create': 'Criação',
        'update': 'Atualização',
        'delete': 'Exclusão',
        'stock_in': 'Entrada',
        'stock_out': 'Saída'
    };
    return types[type] || type;
}

// ===== EVENT LISTENERS =====

elements.addProduct.addEventListener('click', addOrUpdateProduct);
elements.resetForm.addEventListener('click', resetProductForm);
elements.applyOp.addEventListener('click', applyQuickOperation);

// ===== INICIALIZAÇÃO =====

// Modifique a função showApp para carregar os dados quando o painel admin for mostrado
const originalShowApp = showApp;
showApp = function(role, email) {
    originalShowApp(role, email);
    
    if (role === 'admin') {
        // Carregar dados do admin
        loadProducts();
        loadTransactions();
        
        // Configurar atualização automática a cada 30 segundos
        setInterval(() => {
            loadProducts();
            loadTransactions();
        }, 30000);
    }
};
// =========================================================================
// FIREBASE - IMPORTS E CONFIG
// =========================================================================
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
import { initializeFirestore, getFirestore, doc, setDoc, getDoc, serverTimestamp, persistentLocalCache, persistentMultipleTabManager } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyATJ1ZGggZti53nko9LMemQFo7wHwaWXVE",
  authDomain: "banco-de-dados-4dd4d.firebaseapp.com",
  projectId: "banco-de-dados-4dd4d",
  storageBucket: "banco-de-dados-4dd4d.firebasestorage.app",
  messagingSenderId: "1002214156963",
  appId: "1:1002214156963:web:43aeca6f25a71f42fced16",
  measurementId: "G-5NL2Z4D91B"
};

let app;
if (getApps().length === 0) app = initializeApp(firebaseConfig); else app = getApps()[0];
try { getAnalytics(app); } catch(e) {}

let db;
try {
  db = initializeFirestore(app, { localCache: persistentLocalCache({ tabManager: persistentMultipleTabManager() }) });
} catch(e) { db = getFirestore(app); }
const auth = getAuth(app);

// Helpers
const el = (id)=>document.getElementById(id);
const log = (...a)=>console.log('[Firebase]',...a);
const SHOP_ID = 'mainADM';
const SHOP_DOC_PATH = ['shops', SHOP_ID];

// ===== UI helpers (NÃO MUDA ESTILO) =====
function showApp(role, email){
  el('userEmail').textContent = email;
  if(role==='admin'){
    el('userRole').textContent = ' • ADM';
    el('userRole').className = 'role-admin';
    el('userSubtitle').textContent = 'Painel de Administração';
    el('adminPanel').style.display = 'block';
    el('clientPanel').style.display = 'none';
  } else {
    el('userRole').textContent = ' • Cliente';
    el('userRole').className = 'role-client';
    el('userSubtitle').textContent = 'Área do Cliente';
    el('adminPanel').style.display = 'none';
    el('clientPanel').style.display = 'block';
  }
  // some fade
  const app = el('app');
  app.style.display = 'block';
  requestAnimationFrame(()=>{ app.style.opacity = '1'; });

  // esconder login COM GARANTIA DE NÃO SOBREPOR
  el('loginCard').classList.add('hidden-login');
  el('screen-root').classList.add('hidden-login');
}

function showLogin(){
  el('app').style.opacity = '0';
  el('app').style.display = 'none';
  el('screen-root').classList.remove('hidden-login');
  el('loginCard').classList.remove('hidden-login');
  // anima
  requestAnimationFrame(()=>{
    el('loginCard').style.transform='translateY(0)';
    el('loginCard').style.opacity='1';
  });
}

// ===== Dados base =====
async function ensureShop(){
  try {
    const ref = doc(db, ...SHOP_DOC_PATH);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref,{ name:'Lucão Store', createdAt: serverTimestamp() });
      log('Loja criada.');
    }
  } catch(e){ console.error('ensureShop', e); }
}

// ===== Registro =====
function registerAdmin(email, password){
  return createUserWithEmailAndPassword(auth, email, password)
    .then(cred => setDoc(doc(db,'users',cred.user.uid), { role:'admin', email: email.toLowerCase() }));
}
function registerClient(email, password){
  return createUserWithEmailAndPassword(auth, email, password)
    .then(cred => setDoc(doc(db,'users',cred.user.uid), { role:'client', email: email.toLowerCase() }));
}

// ===== LOGIN SEM ATRASO (bypass do delay do onAuthStateChanged) =====
async function fastLoginFlow(user){
  try{
    const snap = await getDoc(doc(db,'users', user.uid));
    const role = (snap.exists() && snap.data().role === 'admin') ? 'admin' : 'client';
    showApp(role, user.email);
  }catch(e){
    console.error('fastLoginFlow', e);
    // fallback para cliente
    showApp('client', user.email);
  }
}

// Click handlers
el('loginBtn').onclick = async ()=>{
  const email = el('loginEmail').value.trim();
  const password = el('loginPassword').value;
  if(!email || !email.includes('@') || !password) return alert('Preencha e-mail e senha.');
  try{
    const cred = await signInWithEmailAndPassword(auth, email, password);
    await fastLoginFlow(cred.user); // <- entra no painel sem esperar onAuthStateChanged
  }catch(e){
    console.error('Erro login ADM', e);
    alert('Erro no Login: ' + (e.message || e.code));
  }
};
el('registerBtn').onclick = async ()=>{
  const email = el('loginEmail').value.trim();
  const password = el('loginPassword').value;
  if(!email || !email.includes('@')) return alert('Digite um e-mail válido.');
  if(!password) return alert('Digite uma senha.');
  try{
    await registerAdmin(email,password);
    alert('Conta de administrador registrada com sucesso!');
    // opcional: já entrar
    const cred = await signInWithEmailAndPassword(auth, email, password);
    await fastLoginFlow(cred.user);
  }catch(e){ alert('Erro ao registrar ADM: ' + (e.message || e.code)); }
};

el('clientLoginBtn').onclick = async ()=>{
  const email = el('clientEmail').value.trim();
  const password = el('clientPassword').value;
  if(!email || !email.includes('@') || !password) return alert('Preencha e-mail e senha.');
  try{
    const cred = await signInWithEmailAndPassword(auth, email, password);
    await fastLoginFlow(cred.user); // <- entra no painel sem atraso
  }catch(e){
    console.error('Erro login Cliente', e);
    alert('Erro no Login: ' + (e.message || e.code));
  }
};
el('clientRegisterBtn').onclick = async ()=>{
  const email = el('clientEmail').value.trim();
  const password = el('clientPassword').value;
  if(!email || !email.includes('@')) return alert('Digite um e-mail válido.');
  if(!password) return alert('Digite uma senha.');
  try{
    await registerClient(email,password);
    alert('Conta de cliente registrada com sucesso!');
    const cred = await signInWithEmailAndPassword(auth, email, password);
    await fastLoginFlow(cred.user);
  }catch(e){ alert('Erro ao registrar cliente: ' + (e.message || e.code)); }
};

// Tabs
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const type = tab.getAttribute('data-tab');
    el('adminLogin').style.display = (type==='admin') ? 'block':'none';
    el('clientLogin').style.display = (type==='client') ? 'block':'none';
  });
});
// Acesso ADM
el('adminAccessBtn').onclick = ()=>{
  const pass = el('adminAccessPassword').value;
  if(pass==='Lucãoadm'){
    el('adminAccessForm').style.display='none';
    el('adminLoginForm').style.display='block';
  }else alert('Senha de acesso ADM incorreta!');
};
// Logout
el('logoutBtn').onclick = async ()=>{
  try{ await signOut(auth); }catch(e){}
  showLogin();
};

// Boot
(async()=>{
  await ensureShop();
  // estado inicial: mostrar login centralizado
  showLogin();
  onAuthStateChanged(auth, async (user)=>{
    // mantém compatibilidade: se o usuário já estiver logado ao abrir a página,
    // entra direto sem sobreposição.
    if(user){
      await fastLoginFlow(user);
    }else{
      showLogin();
    }
  });
})();
  </script>
</body>
</html>
